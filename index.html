<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Creator</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #1a202c; /* bg-gray-900 */
            color: #e2e8f0; /* text-gray-200 */
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen flex flex-col items-center justify-start p-4 md:p-8">

    <div class="w-full max-w-2xl bg-gray-800 rounded-xl shadow-lg p-6 mb-6">
        <h1 class="text-3xl font-bold text-center text-indigo-400 mb-4">Game Creator</h1>
        <p class="text-center text-sm mb-6 text-gray-400">
            Enter a prompt to generate a game.
        </p>

        <div id="user-id-display" class="text-center text-xs text-gray-500 mb-4 break-all hidden"></div>

        <div class="mb-4">
            <textarea
                id="prompt-input"
                class="w-full h-24 p-3 bg-gray-700 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-none text-sm placeholder-gray-400"
                placeholder="e.g., A simple platformer where a square jumps over triangles. A memory game with pairs of colored circles."
            ></textarea>
        </div>

        <button
            id="create-game-btn"
            class="w-full py-3 px-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
        >
            Create Game
        </button>

        <div id="status-message" class="mt-4 p-3 text-sm rounded-lg text-center hidden"></div>
    </div>

    <div id="game-container" class="w-full max-w-2xl bg-gray-800 rounded-xl shadow-lg overflow-hidden border border-gray-700 mt-6 flex-grow flex flex-col hidden">
        <h2 class="text-xl font-bold text-center p-4 bg-gray-700 border-b border-gray-600 text-indigo-400">Your Game</h2>
        <div class="flex-grow">
            <iframe id="game-iframe" title="Generated Game" class="w-full h-full bg-white" sandbox="allow-scripts"></iframe>
        </div>
    </div>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // DOM elements
        const promptInput = document.getElementById('prompt-input');
        const createGameBtn = document.getElementById('create-game-btn');
        const statusMessage = document.getElementById('status-message');
        const gameContainer = document.getElementById('game-container');
        const gameIframe = document.getElementById('game-iframe');
        const userIdDisplay = document.getElementById('user-id-display');

        let db = null;
        let userId = null;
        let auth = null;

        /**
         * Initializes Firebase and authenticates the user.
         */
        const initFirebase = async () => {
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Sign in anonymously or with a custom token.
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                // Listen for auth state changes to get the user ID.
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `User ID: ${userId}`;
                        userIdDisplay.classList.remove('hidden');
                        
                        // Set up a real-time listener for the user's game.
                        const userDocRef = doc(db, getUserDocPath());
                        onSnapshot(userDocRef, (docSnap) => {
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                if (data.gameHtml) {
                                    renderGame(data.gameHtml);
                                }
                            }
                        });
                    } else {
                        userId = null;
                        userIdDisplay.classList.add('hidden');
                    }
                });
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                showStatusMessage("Firebase initialization failed. Game saving will not work.", 'bg-red-800 text-red-200');
            }
        };

        /**
         * Get the Firestore document path for the current user's data.
         * @returns {string} The document path.
         */
        const getUserDocPath = () => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            return `artifacts/${appId}/users/${userId}/game-generator`;
        };

        /**
         * Displays a status or error message.
         * @param {string} message The message to display.
         * @param {string} className The Tailwind CSS class for styling.
         */
        const showStatusMessage = (message, className) => {
            statusMessage.textContent = message;
            statusMessage.className = `mt-4 p-3 text-sm rounded-lg text-center ${className}`;
            statusMessage.classList.remove('hidden');
        };

        /**
         * Renders the generated game code in the iframe.
         * @param {string} html The HTML code for the game.
         */
        const renderGame = (html) => {
            gameIframe.srcdoc = html;
            gameContainer.classList.remove('hidden');
        };

        /**
         * Handles the game creation process.
         */
        const handleCreateGame = async () => {
            const prompt = promptInput.value.trim();
            if (!prompt) {
                showStatusMessage("Please enter a prompt to create a game.", 'bg-red-800 text-red-200');
                return;
            }

            createGameBtn.disabled = true;
            showStatusMessage("Creating your game...", 'bg-blue-800 text-blue-200');

            const fullPrompt = `You are a game development assistant. Your task is to generate the complete, self-contained HTML/CSS/JS code for a simple game based on the user's prompt. The game must be a single HTML file with all CSS in a <style> tag and all JavaScript in a <script> tag. The game must be fully contained within the <body> tag. Do not use any external files, libraries, or CDNs. Ensure the game is responsive and playable on a mobile phone. Do not include any placeholder text or external image links. Use only basic colors and shapes. The user's prompt is: ${prompt}.`;

            try {
                const chatHistory = [{ role: "user", parts: [{ text: fullPrompt }] }];
                const payload = {
                    contents: chatHistory,
                };
                
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                let response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                
                // Implement exponential backoff for retries
                let retries = 0;
                while (!response.ok && retries < 5) {
                    await new Promise(res => setTimeout(res, Math.pow(2, retries) * 1000));
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });
                    retries++;
                }

                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }
                
                const result = await response.json();
                const generatedCode = result.candidates[0].content.parts[0].text;

                // Extract the code block from the response.
                const htmlMatch = generatedCode.match(/```html\n([\s\S]*?)```/);
                const gameCode = htmlMatch ? htmlMatch[1] : generatedCode;

                if (userId) {
                    const userDocRef = doc(db, getUserDocPath());
                    await setDoc(userDocRef, {
                        gameHtml: gameCode,
                        timestamp: new Date(),
                    }, { merge: true });
                }

                renderGame(gameCode);
                showStatusMessage("Game created successfully!", 'bg-green-800 text-green-200');

            } catch (e) {
                console.error("Failed to generate game:", e);
                showStatusMessage("Sorry, I couldn't create a game with that prompt. Please try a different one.", 'bg-red-800 text-red-200');
            } finally {
                createGameBtn.disabled = false;
            }
        };

        // Attach event listener
        createGameBtn.addEventListener('click', handleCreateGame);
        
        // Initialize Firebase on window load
        window.onload = initFirebase;
    </script>

</body>
</html>

