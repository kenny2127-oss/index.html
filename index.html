<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Accessible Pokémon — Map + 300 Pokémon (placeholders)</title>
<style>
:root{--nav:#222;--accent:#9be29b;--bg:#f7fbff}
html,body{height:100%;margin:0;font-family:system-ui,Arial,Helvetica,sans-serif;background:var(--bg);color:#111;display:flex;flex-direction:column;}
main{flex:1;overflow:auto;padding:12px 12px 92px;}
nav{display:flex;gap:0;position:fixed;bottom:0;left:0;right:0;background:var(--nav);color:#fff;z-index:10}
nav button{flex:1;padding:12px 8px;border:0;background:transparent;color:#fff;font-size:15px;cursor:pointer}
nav button.active{background:#111;outline:3px solid #ff0}
h1{margin:8px 0 6px}
.panel{background:#fff;border:1px solid #e3e7ef;border-radius:10px;padding:10px}
.flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn{padding:9px 12px;border:0;border-radius:9px;background:#1976d2;color:#fff;cursor:pointer}
.btn.alt{background:var(--accent);color:#000}
.btn.ghost{background:transparent;border:1px solid #cfd6e4;color:#000}
select,input,button{font-size:15px}
label{display:block;margin:6px 0 2px}
small,.sub{color:#555}
.kv{display:flex;justify-content:space-between;border-bottom:1px dashed #eee;padding:6px 0}
.grid{display:grid;gap:8px}
@media(min-width:720px){ main{padding:18px 18px 116px} nav button{font-size:16px} }
</style>
</head>
<body>
<main>
  <!-- HOME -->
  <section id="home" class="tab" role="tabpanel" aria-labelledby="tab-home">
    <h1>Home</h1>
    <div id="player-info" class="panel" aria-live="polite">Level 1 | XP 0 | Money $1000 | Bank $0 | Location: Forest</div>

    <div class="flex" aria-label="Quick actions">
      <button id="open-pokedex" class="btn alt" aria-expanded="false">Open Pokedex</button>
      <button id="save-manual" class="btn ghost">Save Now</button>
      <button id="reset-game" class="btn ghost">Reset Save</button>
    </div>

    <div class="panel">
      <h2 style="margin:0 0 6px">Bank</h2>
      <div class="flex">
        <label for="bank-deposit">Deposit</label>
        <select id="bank-deposit" aria-label="Deposit amount">
          <option value="">Choose</option>
          <option value="10">$10</option>
          <option value="20">$20</option>
          <option value="50">$50</option>
          <option value="all">All</option>
        </select>
        <label for="bank-withdraw">Withdraw</label>
        <select id="bank-withdraw" aria-label="Withdraw amount">
          <option value="">Choose</option>
          <option value="10">$10</option>
          <option value="20">$20</option>
          <option value="50">$50</option>
          <option value="all">All</option>
        </select>
      </div>
    </div>

    <div class="panel" id="party-panel">
      <h2 style="margin:0 0 6px">Party (max 6)</h2>
      <div id="party-list" class="grid" aria-live="polite"></div>
      <h3 style="margin:10px 0 6px">Box</h3>
      <div id="box-list" class="grid"></div>
    </div>

    <h2>Pokedex</h2>
    <div id="pokedex-list" class="panel" style="display:none" aria-live="polite;"></div>
  </section>

  <!-- MAP -->
  <section id="map" class="tab" role="tabpanel" aria-labelledby="tab-map">
    <h1>Map</h1>
    <div class="panel">
      <p class="sub">Travel to different locations. Explore and Gather will be affected by your current location.</p>
      <div id="locations-list" class="grid"></div>
      <p id="map-log" aria-live="polite"></p>
    </div>
  </section>

  <!-- INVENTORY -->
  <section id="inventory" class="tab" role="tabpanel" aria-labelledby="tab-inventory">
    <h1>Inventory</h1>
    <div id="inventory-list" class="panel" aria-live="polite"></div>
  </section>

  <!-- EXPLORE -->
  <section id="explore" class="tab" role="tabpanel" aria-labelledby="tab-explore">
    <h1>Explore</h1>
    <div class="panel">
      <p class="sub">Find wild Pokémon. Encounter chances depend on current location.</p>
      <button id="catch-pokemon" class="btn alt">Search & Catch (location-aware)</button>
      <p id="explore-log" aria-live="polite"></p>
    </div>
  </section>

  <!-- GATHER -->
  <section id="gather" class="tab" role="tabpanel" aria-labelledby="tab-gather">
    <h1>Gather</h1>
    <div class="panel">
      <p class="sub">Gather resources from your current location.</p>
      <div class="flex">
        <button id="gather-resource" class="btn alt">Gather Resource (+10 XP)</button>
      </div>
      <p id="gather-log" aria-live="polite"></p>
    </div>
  </section>

  <!-- BATTLE -->
  <section id="battle" class="tab" role="tabpanel" aria-labelledby="tab-battle">
    <h1>Battle</h1>
    <div class="flex">
      <button id="start-battle" class="btn alt">Start Wild Battle (lead)</button>
      <button id="challenge-gym" class="btn">Challenge Gym</button>
    </div>
    <div id="battle-area" style="margin-top:12px;display:none;">
      <div class="panel" id="battle-stats" aria-live="polite"></div>
      <div id="move-buttons" class="flex" style="margin-top:10px;"></div>
    </div>
    <p id="battle-log" aria-live="assertive" style="white-space:pre-wrap;margin-top:10px;"></p>
  </section>

  <!-- TRADE -->
  <section id="trade" class="tab" role="tabpanel" aria-labelledby="tab-trade">
    <h1>Trade</h1>
    <div class="flex">
      <button id="sell-all-top" class="btn alt">Sell All Sellable Items</button>
    </div>
    <label for="trade-mode">Choose Mode</label>
    <select id="trade-mode">
      <option value="buy">Buy Items</option>
      <option value="sell">Sell Items</option>
    </select>
    <div id="trade-panel" class="panel" style="margin-top:10px;"></div>
  </section>
</main>

<nav role="tablist" aria-label="Main tabs">
  <button id="tab-home" class="tab-btn active" data-target="home" role="tab" aria-controls="home">Home</button>
  <button id="tab-map" class="tab-btn" data-target="map" role="tab" aria-controls="map">Map</button>
  <button id="tab-inventory" class="tab-btn" data-target="inventory" role="tab" aria-controls="inventory">Inventory</button>
  <button id="tab-explore" class="tab-btn" data-target="explore" role="tab" aria-controls="explore">Explore</button>
  <button id="tab-gather" class="tab-btn" data-target="gather" role="tab" aria-controls="gather">Gather</button>
  <button id="tab-battle" class="tab-btn" data-target="battle" role="tab" aria-controls="battle">Battle</button>
  <button id="tab-trade" class="tab-btn" data-target="trade" role="tab" aria-controls="trade">Trade</button>
</nav>

<script>
/* ===== Utils & Audio ===== */
const beep = (freq=660, dur=120, type='sine', vol=0.18)=>{
  try{
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const o = ctx.createOscillator(); const g = ctx.createGain();
    o.type=type; o.frequency.value=freq; g.gain.value=vol;
    o.connect(g); g.connect(ctx.destination);
    o.start(); setTimeout(()=>{o.stop(); ctx.close();}, dur);
  }catch(e){}
};
const rng = (min,max)=>Math.floor(Math.random()*(max-min+1))+min;

/* ===== Save / State ===== */
const DEFAULT_PLAYER = {
  level:1, xp:0, money:1000, bank:0,
  inventory:{}, gear:{},
  party:[], box:[], mons:{}, badges:0,
  location: 'Forest' // default
};
let player = loadPlayer();

/* simple migrate/load */
function loadPlayer(){
  const keys = ['pkm_player_v8','pkm_player_v7','pkm_player_v6','pkm_player_v5','pkm_player_v4','pkm_player_v3'];
  for(const k of keys){ const s = localStorage.getItem(k); if(s){ try{
    const parsed = JSON.parse(s);
    if(!('location' in parsed)) parsed.location = 'Forest';
    if(!parsed.party) parsed.party=[];
    if(!parsed.box) parsed.box=[];
    if(!parsed.mons) parsed.mons={};
    localStorage.setItem('pkm_player_v8', JSON.stringify(parsed));
    return parsed;
  }catch(e){} } }
  localStorage.setItem('pkm_player_v8', JSON.stringify(DEFAULT_PLAYER));
  return structuredClone(DEFAULT_PLAYER);
}
function savePlayer(){ localStorage.setItem('pkm_player_v8', JSON.stringify(player)); updateUI(); }
function resetPlayer(){ if(confirm('Reset save? This will clear progress.')){ player = structuredClone(DEFAULT_PLAYER); savePlayer(); location.reload(); } }
function gainXP(amount){
  player.xp += amount;
  while(player.xp>=100){ player.level++; player.xp-=100; beep(880,140,'triangle'); alert(`You leveled up! Level ${player.level}`); }
  savePlayer();
}

/* ===== POKEDEX: first 25 detailed, rest generated to 300 ===== */
const POKEDEX_BASE = [
  {id:1,name:'Bulbasaur',type:'Grass',base:{hp:45,atk:49,def:49,spd:45},moves:['Tackle','Vine Whip','Growl','Leech Seed'],evo:{lvl:16,to:2}},
  {id:2,name:'Ivysaur',type:'Grass',base:{hp:60,atk:62,def:63,spd:60},moves:['Tackle','Vine Whip','Growl','Leech Seed'],evo:{lvl:32,to:3}},
  {id:3,name:'Venusaur',type:'Grass',base:{hp:80,atk:82,def:83,spd:80},moves:['Razor Leaf','Vine Whip','Growl','Sleep Powder'}},
  {id:4,name:'Charmander',type:'Fire',base:{hp:39,atk:52,def:43,spd:65},moves:['Scratch','Ember','Growl','Smokescreen'],evo:{lvl:16,to:5}},
  {id:5,name:'Charmeleon',type:'Fire',base:{hp:58,atk:64,def:58,spd:80},moves:['Ember','Slash','Smokescreen','Leer'],evo:{lvl:36,to:6}},
  {id:6,name:'Charizard',type:'Fire',base:{hp:78,atk:84,def:78,spd:100},moves:['Flamethrower','Slash','Smoke','Wing Attack']},
  {id:7,name:'Squirtle',type:'Water',base:{hp:44,atk:48,def:65,spd:43},moves:['Tackle','Water Gun','Tail Whip','Withdraw'],evo:{lvl:16,to:8}},
  {id:8,name:'Wartortle',type:'Water',base:{hp:59,atk:63,def:80,spd:58},moves:['Water Gun','Bite','Withdraw','Tail Whip'],evo:{lvl:36,to:9}},
  {id:9,name:'Blastoise',type:'Water',base:{hp:79,atk:83,def:100,spd:78},moves:['Hydro Pump','Bite','Withdraw','Skull Bash']},
  {id:10,name:'Caterpie',type:'Bug',base:{hp:45,atk:30,def:35,spd:45},moves:['Tackle','String Shot','Harden','Bug Bite'],evo:{lvl:7,to:11}},
  {id:11,name:'Metapod',type:'Bug',base:{hp:50,atk:20,def:55,spd:30},moves:['Harden','Tackle','String Shot','Bug Bite'],evo:{lvl:10,to:12}},
  {id:12,name:'Butterfree',type:'Bug',base:{hp:60,atk:45,def:50,spd:70},moves:['Confusion','Gust','Poison Powder','Sleep Powder']},
  {id:13,name:'Weedle',type:'Bug',base:{hp:40,atk:35,def:30,spd:50},moves:['Poison Sting','String Shot','Tackle','Harden'],evo:{lvl:7,to:14}},
  {id:14,name:'Kakuna',type:'Bug',base:{hp:45,atk:25,def:50,spd:35},moves:['Harden','Poison Sting','Tackle','String Shot'],evo:{lvl:10,to:15}},
  {id:15,name:'Beedrill',type:'Bug',base:{hp:65,atk:80,def:40,spd:75},moves:['Fury Attack','Twineedle','Rage','Focus Energy']},
  {id:16,name:'Pidgey',type:'Normal',base:{hp:40,atk:45,def:40,spd:56},moves:['Tackle','Gust','Sand Attack','Quick Attack'],evo:{lvl:18,to:17}},
  {id:17,name:'Pidgeotto',type:'Normal',base:{hp:63,atk:60,def:55,spd:71},moves:['Gust','Quick Attack','Sand Attack','Wing Attack'],evo:{lvl:36,to:18}},
  {id:18,name:'Pidgeot',type:'Normal',base:{hp:83,atk:80,def:75,spd:101},moves:['Wing Attack','Quick Attack','Agility','Gust']},
  {id:19,name:'Rattata',type:'Normal',base:{hp:30,atk:56,def:35,spd:72},moves:['Tackle','Quick Attack','Tail Whip','Bite'],evo:{lvl:20,to:20}},
  {id:20,name:'Raticate',type:'Normal',base:{hp:55,atk:81,def:60,spd:97},moves:['Hyper Fang','Quick Attack','Bite','Tail Whip']},
  {id:21,name:'Spearow',type:'Normal',base:{hp:40,atk:60,def:30,spd:70},moves:['Peck','Leer','Fury Attack','Growl'],evo:{lvl:20,to:22}},
  {id:22,name:'Fearow',type:'Normal',base:{hp:65,atk:90,def:65,spd:100},moves:['Drill Peck','Fury Attack','Leer','Agility']},
  {id:23,name:'Ekans',type:'Poison',base:{hp:35,atk:60,def:44,spd:55},moves:['Wrap','Poison Sting','Bite','Glare'],evo:{lvl:22,to:24}},
  {id:24,name:'Arbok',type:'Poison',base:{hp:60,atk:85,def:69,spd:80},moves:['Bite','Acid','Glare','Wrap']},
  {id:25,name:'Pikachu',type:'Electric',base:{hp:35,atk:55,def:40,spd:90},moves:['Thunder Shock','Quick Attack','Tail Whip','Growl'],stoneEvo:{item:'Thunder Stone',to:26}},
  {id:26,name:'Raichu',type:'Electric',base:{hp:60,atk:90,def:55,spd:110},moves:['Thunderbolt','Quick Attack','Slam','Agility']}
];

// generate full POKEDEX to 300
const POKEDEX = [];
for(let i=1;i<=300;i++){
  const base = POKEDEX_BASE.find(p=>p.id===i);
  if(base){
    POKEDEX.push(base);
  } else {
    // placeholder generation
    const name = `Pokémon ${String(i).padStart(3,'0')}`;
    const types = (i%3===0)?'Normal':(i%5===0)?'Water':(i%7===0)?'Rock':'Normal';
    const hpBase = 30 + Math.floor(i/10);
    const atkBase = 25 + Math.floor(i/15);
    const defBase = 20 + Math.floor(i/20);
    const spdBase = 20 + Math.floor(i/12);
    const moves = ['Tackle','Tail Whip','Quick Attack','Struggle'];
    POKEDEX.push({ id:i, name, type: types, base:{hp:hpBase,atk:atkBase,def:defBase,spd:spdBase}, moves });
  }
}

/* ===== Stat helpers ===== */
function calcStats(base,lvl){
  return { hp: Math.max(10, Math.round(base.hp + lvl*2)), atk: Math.max(5, Math.round(base.atk + lvl)), def: Math.max(5, Math.round(base.def + lvl)), spd: Math.max(5, Math.round(base.spd + lvl)) };
}
function createMon(speciesId, lvl=5){
  const sp = POKEDEX.find(p=>p.id===speciesId) || POKEDEX[0];
  return { id: crypto.randomUUID(), speciesId: sp.id, name: sp.name, lvl, xp:0, stats: calcStats(sp.base,lvl), hp: calcStats(sp.base,lvl).hp, gear: {} };
}
function monGainXP(mon, amount){
  mon.xp += amount;
  while(mon.xp>=100){ mon.lvl++; mon.xp-=100; mon.stats = calcStats(POKEDEX.find(p=>p.id===mon.speciesId).base, mon.lvl); mon.hp = mon.stats.hp; tryEvolve(mon); }
}
function tryEvolve(mon){
  const sp = POKEDEX.find(p=>p.id===mon.speciesId);
  if(sp && sp.evo && mon.lvl>=sp.evo.lvl){
    const next = POKEDEX.find(p=>p.id===sp.evo.to);
    if(next){ mon.speciesId = next.id; mon.name = next.name; mon.stats = calcStats(next.base, mon.lvl); mon.hp = mon.stats.hp; beep(920,160,'sawtooth'); toast(`Your ${sp.name} evolved into ${next.name}!`); }
  }
}
function useStone(mon,item){
  const sp = POKEDEX.find(p=>p.id===mon.speciesId);
  if(sp && sp.stoneEvo && sp.stoneEvo.item===item){
    const next = POKEDEX.find(p=>p.id===sp.stoneEvo.to);
    mon.speciesId=next.id; mon.name=next.name; mon.stats=calcStats(next.base,mon.lvl); mon.hp=mon.stats.hp;
    toast(`${sp.name} evolved into ${next.name} using ${item}!`); return true;
  }
  return false;
}

/* ===== Map data: locations & pools ===== */
const LOCATIONS = {
  'Forest': {desc:'Dense woods — bugs, birds, and grass types.', encounterPool: [1,10,13,16,3,12,25], resources:['Berry','Leaf Stone','Herb','Wood']},
  'Cave': {desc:'Dark caves — stones, minerals and rare cave Pokémon.', encounterPool: [11,14,23,24,19,20,30], resources:['Moon Stone','Iron','Crystal','Flint']},
  'Coast': {desc:'Sandy coast & waves — water-type encounters.', encounterPool: [7,8,9,25,31,32], resources:['Water Stone','Pearl','Shell','Seaweed']},
  'Mountain': {desc:'Rocky heights — fire/rock types and flint.', encounterPool: [15,6,20,24,33,34], resources:['Fire Stone','Flint','Iron','Rare Ore']},
  'Plains': {desc:'Open fields — common critters and some electric types.', encounterPool: [16,21,19,25,35], resources:['Cotton','Berry','Thunder Stone','Grass Fiber']},
  'City': {desc:'Urban area — traders, shops, and rare spawns.', encounterPool: [25,26,40,41,42], resources:['Coins','Trinket','Box Parts']}
};

/* ===== UI Helpers ===== */
function toast(msg){ alert(msg); }
function money(n){ return `$${n}`; }

/* ===== UI Bindings ===== */
const infoEl = document.getElementById('player-info');
const locationsListEl = document.getElementById('locations-list');
const mapLog = document.getElementById('map-log');
const exploreLog = document.getElementById('explore-log');
const gatherLog = document.getElementById('gather-log');

/* build map UI */
function buildMapUI(){
  locationsListEl.innerHTML='';
  Object.keys(LOCATIONS).forEach(loc=>{
    const card=document.createElement('div'); card.className='panel';
    const title=document.createElement('div'); title.innerHTML=`<b>${loc}</b>`;
    const desc=document.createElement('div'); desc.className='sub'; desc.innerText=LOCATIONS[loc].desc;
    const btn=document.createElement('button'); btn.className='btn alt'; btn.innerText='Travel Here';
    btn.addEventListener('click', ()=>travelTo(loc));
    card.append(title,desc,btn);
    locationsListEl.appendChild(card);
  });
}
function travelTo(loc){
  player.location = loc;
  savePlayer();
  mapLog.innerText = `Traveled to ${loc}.`;
  mapLog.setAttribute('aria-live','polite');
  beep(720,120,'sine');
}

/* Tabs */
const tabButtons = document.querySelectorAll('nav .tab-btn');
const tabs = document.querySelectorAll('main .tab');
function showTab(targetId){ tabs.forEach(t=>t.style.display=(t.id===targetId)?'block':'none'); tabButtons.forEach(b=>b.classList.toggle('active', b.dataset.target===targetId)); }
tabs.forEach(t=>t.style.display='none'); showTab('home');
tabButtons.forEach(btn=>btn.addEventListener('click',()=>showTab(btn.dataset.target)));

/* Bank */
const bankDepositSel=document.getElementById('bank-deposit');
const bankWithdrawSel=document.getElementById('bank-withdraw');
bankDepositSel.addEventListener('change',()=>{
  const v=bankDepositSel.value; if(!v) return;
  let amt = v==='all'?player.money:parseInt(v,10);
  if(player.money>=amt){ player.money-=amt; player.bank+=amt; savePlayer(); }
  bankDepositSel.value='';
});
bankWithdrawSel.addEventListener('change',()=>{
  const v=bankWithdrawSel.value; if(!v) return;
  let amt = v==='all'?player.bank:parseInt(v,10);
  if(player.bank>=amt){ player.bank-=amt; player.money+=amt; savePlayer(); }
  bankWithdrawSel.value='';
});

/* Inventory */
function addItem(name, qty=1){ player.inventory[name]=(player.inventory[name]||0)+qty; }
function removeItem(name, qty=1){ if(!player.inventory[name]) return false; player.inventory[name]-=qty; if(player.inventory[name]<=0) delete player.inventory[name]; return true; }
function updateInventoryUI(){ const inv=document.getElementById('inventory-list'); inv.innerHTML=''; const entries=Object.entries(player.inventory); if(entries.length===0){ inv.textContent='Inventory is empty.'; return; } entries.forEach(([k,v])=>{ const row=document.createElement('div'); row.className='kv'; const useBtn=usableItemButton(k); row.innerHTML=`<span>${k}</span><b>x${v}</b>`; inv.appendChild(row); if(useBtn) inv.appendChild(useBtn); }); }
function usableItemButton(item){
  const healMap={'Berry':10,'Potion':20,'Super Potion':50};
  if(healMap[item]){
    const btn=document.createElement('button'); btn.className='btn alt'; btn.textContent=`Use ${item} (heal ${healMap[item]})`;
    btn.addEventListener('click',()=>{ if(player.party.length===0){ toast('No Pokémon in party.'); return; } const mon=player.mons[player.party[0]]; if(!mon){ toast('No valid party Pokémon.'); return; } if(removeItem(item,1)){ mon.hp=Math.min(mon.stats.hp, mon.hp+healMap[item]); savePlayer(); toast(`${mon.name} healed!`); }});
    return btn;
  }
  const stones=['Thunder Stone','Leaf Stone','Moon Stone','Water Stone','Fire Stone'];
  if(stones.includes(item)){
    const btn=document.createElement('button'); btn.className='btn'; btn.textContent=`Use ${item} on lead`;
    btn.addEventListener('click',()=>{ if(player.party.length===0){ toast('No Pokémon in party.'); return; } const mon=player.mons[player.party[0]]; if(useStone(mon,item)){ removeItem(item,1); savePlayer(); } else toast('It had no effect.'); });
    return btn;
  }
  return null;
}

/* Party Management */
function refreshPartyUI(){
  const partyEl=document.getElementById('party-list'); const boxEl=document.getElementById('box-list'); partyEl.innerHTML=''; boxEl.innerHTML='';
  player.party.forEach((id,idx)=>{ const m=player.mons[id]; if(!m) return; const sp=POKEDEX.find(p=>p.id===m.speciesId); const card=document.createElement('div'); card.className='panel'; card.innerHTML=`<b>${m.name}</b> Lv ${m.lvl} — HP ${m.hp}/${m.stats.hp}<br><small>${sp.type||''}</small>`; const up=document.createElement('button'); up.className='btn ghost'; up.textContent='↑'; const down=document.createElement('button'); down.className='btn ghost'; down.textContent='↓'; const remove=document.createElement('button'); remove.className='btn'; remove.textContent='Remove'; up.addEventListener('click',()=>{ if(idx>0){ [player.party[idx-1],player.party[idx]]=[player.party[idx],player.party[idx-1]]; savePlayer(); } }); down.addEventListener('click',()=>{ if(idx<player.party.length-1){ [player.party[idx+1],player.party[idx]]=[player.party[idx],player.party[idx+1]]; savePlayer(); } }); remove.addEventListener('click',()=>{ player.box.push(id); player.party.splice(idx,1); savePlayer(); }); const row=document.createElement('div'); row.className='flex'; row.append(up,down,remove); card.appendChild(row); partyEl.appendChild(card); });
  player.box.forEach((id)=>{ const m=player.mons[id]; if(!m) return; const sp=POKEDEX.find(p=>p.id===m.speciesId); const card=document.createElement('div'); card.className='panel'; card.innerHTML=`<b>${m.name}</b> Lv ${m.lvl} — HP ${m.hp}/${m.stats.hp}<br><small>${sp.type||''}</small>`; const add=document.createElement('button'); add.className='btn alt'; add.textContent='Add to Party'; add.addEventListener('click',()=>{ if(player.party.length>=6){ toast('Party is full (6).'); return; } player.party.push(id); player.box = player.box.filter(x=>x!==id); savePlayer(); }); card.appendChild(add); boxEl.appendChild(card); });
}

/* Explore / Encounters depend on player.location */
function getEncounterPoolForLocation(loc){
  const cfg = LOCATIONS[loc] || LOCATIONS['Forest'];
  return cfg.encounterPool;
}
function getResourcePoolForLocation(loc){
  const cfg = LOCATIONS[loc] || LOCATIONS['Forest'];
  return cfg.resources;
}
function weightedPickFromArray(arr){
  // arr can be numeric id array: pick random
  return arr[Math.floor(Math.random()*arr.length)];
}

document.getElementById('catch-pokemon').addEventListener('click',()=>{
  const loc = player.location || 'Forest';
  const pool = getEncounterPoolForLocation(loc);
  const sid = weightedPickFromArray(pool);
  const sp = POKEDEX.find(p=>p.id===sid) || POKEDEX[0];
  const wildLvl = rng(3, player.level+3);
  exploreLog.innerText = `A wild ${sp.name} (Lv ${wildLvl}) appeared in ${loc}!`;
  setTimeout(()=>{
    const caught = Math.random() < 0.6;
    if(caught){
      const mon = createMon(sid, wildLvl);
      player.mons[mon.id]=mon;
      if(player.party.length<6) player.party.push(mon.id); else player.box.push(mon.id);
      gainXP(20);
      beep(760,130,'square');
      exploreLog.innerText = `You caught ${sp.name}! (+20 XP)`;
      savePlayer();
    } else {
      exploreLog.innerText = `${sp.name} fled!`;
    }
  },450);
});

/* Gather uses player.location pool */
const ZONE_TABLE = {}; // we'll map locations to resources using LOCATIONS above
Object.keys(LOCATIONS).forEach(k=>{ ZONE_TABLE[k] = LOCATIONS[k].resources; });

document.getElementById('gather-resource').addEventListener('click',()=>{
  const loc = player.location || 'Forest';
  const pool = ZONE_TABLE[loc] || ['Berry'];
  const item = pool[Math.floor(Math.random()*pool.length)];
  addItem(item,1);
  gatherLog.innerText = `You gathered: ${item} in ${loc}. (+10 XP)`;
  gainXP(10);
  savePlayer();
});

/* Trade (buy/sell + Sell All top) */
const tradeMode=document.getElementById('trade-mode'); const tradePanel=document.getElementById('trade-panel');
document.getElementById('sell-all-top').addEventListener('click',()=>{
  let total = 0;
  for(const [k,v] of Object.entries(player.inventory)){ if(v>0){ total += v*sellPrice(k); delete player.inventory[k]; } }
  if(total>0){ player.money += total; toast(`Sold everything for ${money(total)}.`); savePlayer(); }
  else tradePanel.innerText='No items to sell.';
});
function buyPrice(item){ const map={'Potion':20,'Super Potion':50,'Berry':8,'Shield Vest':120,'Battle Gloves':120,'Healing Ring':150,'Leaf Stone':200,'Moon Stone':220,'Water Stone':220,'Fire Stone':220,'Thunder Stone':240}; return map[item]||25; }
function sellPrice(item){ return Math.floor(buyPrice(item)*0.5); }
function updateTradeUI(){
  tradePanel.innerHTML='';
  if(tradeMode.value==='buy'){
    const items=['Potion','Super Potion','Berry','Shield Vest','Battle Gloves','Healing Ring','Leaf Stone','Moon Stone','Water Stone','Fire Stone','Thunder Stone'];
    items.forEach(it=>{ const b=document.createElement('button'); b.className='btn alt'; b.textContent=`Buy ${it} (${money(buyPrice(it))})`; b.addEventListener('click',()=>{ const price=buyPrice(it); if(player.money>=price){ player.money-=price; addItem(it,1); savePlayer(); toast(`Bought ${it}.`); } else toast('Not enough money.'); }); tradePanel.appendChild(b); });
  } else {
    const entries = Object.entries(player.inventory).filter(([k,v])=>v>0);
    if(entries.length===0){ tradePanel.innerText='No items to sell.'; return; }
    entries.forEach(([k,v])=>{ const row=document.createElement('div'); row.className='kv'; const btn=document.createElement('button'); btn.className='btn'; btn.textContent=`Sell (${money(sellPrice(k))})`; btn.addEventListener('click',()=>{ removeItem(k,1); player.money+=sellPrice(k); savePlayer(); updateTradeUI(); }); row.innerHTML=`<span>${k} x${v}</span>`; tradePanel.appendChild(row); tradePanel.appendChild(btn); });
  }
}
tradeMode.addEventListener('change',updateTradeUI);

/* Gear effects and equip */
function gearAttackMult(mon){ let m=1; if(mon.gear['Battle Gloves']) m+=0.2; return m; }
function gearDefenseMult(mon){ let m=1; if(mon.gear['Shield Vest']) m+=0.2; return m; }
function gearOnWin(mon){ if(mon.gear['Healing Ring']){ mon.hp=Math.min(mon.stats.hp, mon.hp+10); } }
function maybeEquipGearFromInventory(){ const gears=['Shield Vest','Battle Gloves','Healing Ring']; Object.keys(player.inventory).forEach(k=>{ if(gears.includes(k) && player.inventory[k]>0 && player.party.length>0){ const mon=player.mons[player.party[0]]; if(!mon.gear[k]){ mon.gear[k]=true; player.inventory[k]--; toast(`Equipped ${k} to ${mon.name}.`); } } }); }

/* Battle system (same as earlier but location-independent) */
const battleArea=document.getElementById('battle-area'); const battleStats=document.getElementById('battle-stats'); const moveButtons=document.getElementById('move-buttons'); const battleLog=document.getElementById('battle-log');
let battle=null;
function startWildBattle(){ if(player.party.length===0){ toast('No Pokémon in party.'); return; } const lead = player.mons[player.party[0]]; if(!lead){ toast('Invalid lead.'); return; } maybeEquipGearFromInventory(); const wildSid = weightedPickFromArray(getEncounterPoolForLocation(player.location)); const wildSp = POKEDEX.find(p=>p.id===wildSid); const wildLvl = rng(Math.max(3,lead.lvl-1), lead.lvl+2); battle={ type:'wild', player: JSON.parse(JSON.stringify(lead)), enemy: { name:wildSp.name, speciesId:wildSp.id, lvl:wildLvl, stats:calcStats(wildSp.base,wildLvl), hp:calcStats(wildSp.base,wildLvl).hp } }; battleArea.style.display='block'; moveButtons.innerHTML=''; getMovesForSpecies(battle.player.speciesId).forEach(mv=>{ const b=document.createElement('button'); b.className='btn alt'; b.textContent=mv; b.addEventListener('click',()=>playerMove(mv)); moveButtons.appendChild(b); }); battleLog.innerText=`A wild ${wildSp.name} (Lv ${wildLvl}) appeared!`; renderBattle(); }
function startGymBattle(){ if(player.level<nextGymLevel()){ toast(`Next gym unlocks at level ${nextGymLevel()}.`); return; } if(player.party.length===0){ toast('No Pokémon in party.'); return; } const lead = player.mons[player.party[0]]; const gymLvl = player.level + 2 + Math.floor(player.badges*1.5); const candidates=[6,9,18,20,24,26]; const sid = candidates[Math.floor(Math.random()*candidates.length)]; const sp = POKEDEX.find(p=>p.id===sid); battle={ type:'gym', player: JSON.parse(JSON.stringify(lead)), enemy: { name:`Leader's ${sp.name}`, speciesId:sp.id, lvl:gymLvl, stats:calcStats(sp.base,gymLvl), hp:calcStats(sp.base,gymLvl).hp } }; battleArea.style.display='block'; moveButtons.innerHTML=''; getMovesForSpecies(battle.player.speciesId).forEach(mv=>{ const b=document.createElement('button'); b.className='btn alt'; b.textContent=mv; b.addEventListener('click',()=>playerMove(mv)); moveButtons.appendChild(b); }); battleLog.innerText=`Gym Leader challenges you with ${sp.name} (Lv ${gymLvl})!`; renderBattle(); }
function nextGymLevel(){ return (player.badges+1)*5; }
document.getElementById('start-battle').addEventListener('click', startWildBattle);
document.getElementById('challenge-gym').addEventListener('click', startGymBattle);
function getMovesForSpecies(sid){ return (POKEDEX.find(p=>p.id===sid)?.moves)||['Tackle']; }
function renderBattle(){ const p=battle.player, e=battle.enemy; battleStats.innerText=`Your ${p.name} — Lv ${p.lvl} — HP ${p.hp}/${p.stats.hp}\nEnemy ${e.name} — Lv ${e.lvl} — HP ${e.hp}/${e.stats.hp}`; }
function calcDamage(attacker, defender, move){ const base = (move.includes('Ember')||move.includes('Flame')||move.includes('Fire'))?20:(move.includes('Water')||move.includes('Hydro'))?20:(move.includes('Thunder')||move.includes('Bolt')||move.includes('Shock'))?22:(move.includes('Vine')||move.includes('Leaf')||move.includes('Razor'))?20:(move.includes('Gust')||move.includes('Wing'))?18:(move.includes('Hyper')||move.includes('Slash')||move.includes('Fang'))?24:16; const atk = attacker.stats.atk * (attacker.id?gearAttackMult(player.mons[attacker.id]||attacker):1); const def = defender.stats.def * (defender.id?gearDefenseMult(player.mons[defender.id]||defender):1); const levelFactor = 1 + attacker.lvl*0.05; const dmg = Math.max(5, Math.round((base + atk*0.6) * levelFactor / (def*0.35))); return dmg; }
function playerMove(move){ if(!battle) return; if(battle.enemy.hp<=0){ battleLog.innerText+=' Enemy already defeated.'; return; } const dmg = calcDamage(battle.player, battle.enemy, move); battle.enemy.hp = Math.max(0, battle.enemy.hp - dmg); battleLog.innerText = `You used ${move}! It dealt ${dmg} damage.`; renderBattle(); if(battle.enemy.hp<=0){ return endBattle(true); } setTimeout(()=>{ if(!battle) return; const enemyMove = getMovesForSpecies(battle.enemy.speciesId)[0] || 'Tackle'; const dmge = calcDamage(battle.enemy, battle.player, enemyMove); battle.player.hp = Math.max(0, battle.player.hp - dmge); battleLog.innerText += `\nEnemy used ${enemyMove}! You took ${dmge}.`; renderBattle(); if(battle.player.hp<=0){ endBattle(false); } }, 450); }
function endBattle(win){ const leadId = player.party[0]; const lead = player.mons[leadId]; if(!lead){ battle=null; return; } if(win){ beep(980,150,'square'); battleLog.innerText += `\nYou won the battle! (+50 XP, +$100)`; player.money += 100; gainXP(50); monGainXP(lead, 70); gearOnWin(lead); lead.hp = Math.min(lead.stats.hp, lead.hp + 10); if(battle.type==='gym'){ player.badges += 1; toast(`You earned a Badge! Total badges: ${player.badges}`); } }else{ battleLog.innerText += `\nYou lost... Rest up and try again.`; player.money = Math.max(0, player.money - 20); lead.hp = Math.max(1, Math.floor(lead.stats.hp*0.3)); } player.mons[leadId]=lead; battle=null; moveButtons.innerHTML=''; savePlayer(); }

/* Save/Reset */
document.getElementById('save-manual').addEventListener('click',()=>{ savePlayer(); toast('Saved.'); });
document.getElementById('reset-game').addEventListener('click', resetPlayer);

/* Player Info + Screens */
function updateUI(){
  infoEl.innerText = `Level ${player.level} | XP ${player.xp} | Money ${money(player.money)} | Bank ${money(player.bank)} | Location: ${player.location}`;
  updateInventoryUI(); updateTradeUI(); refreshPartyUI(); buildMapUI();
}

/* Initial seed: starter if none */
(function bootstrap(){
  if(player.party.length===0 && Object.keys(player.mons).length===0){
    const starters=[1,4,7]; const s=starters[Math.floor(Math.random()*starters.length)]; const mon=createMon(s,5);
    player.mons[mon.id]=mon; player.party.push(mon.id);
  }
  savePlayer();
})();

updateUI();

/* Accessibility niceties */
document.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && pokedexListEl.style.display==='block'){ pokedexListEl.style.display='none'; pokedexBtn.innerText='Open Pokedex'; pokedexBtn.setAttribute('aria-expanded','false'); } });
</script>
</body>
</html>