<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pokémon Adventure</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#3b4cca">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
body{font-family:sans-serif;margin:0;background:#1a202c;color:#e6eef8;padding-bottom:60px;}
header{padding:10px;text-align:center;}
footer{position:fixed;bottom:0;left:0;width:100%;display:flex;background:#3b4cca;z-index:1000;}
footer button{flex:1;background:white;border:none;padding:12px 0;cursor:pointer;}
footer button[aria-selected="true"]{background:#ffcb05;font-weight:bold;}
section{display:none;padding:20px;}
section.active{display:block;}
#installBtn,#dailyRewardBtn,#catchBtn,#exportBtn,#importBtn,#startBattleBtn,#transferButton{margin:10px;padding:10px;border:none;border-radius:8px;background:#ffcb05;cursor:pointer;}
#liveRegion{position:absolute;left:-9999px;}
#pokedex,.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(80px,1fr));gap:10px;margin-top:10px;}
.card{background:#2d3748;border-radius:10px;padding:8px;text-align:center;}
button:disabled{opacity:0.5;cursor:not-allowed;}
textarea,input,select{width:100%;margin:4px 0;padding:6px;border-radius:6px;border:none;}
#battleArea{background:#2d3748;padding:10px;border-radius:10px;margin-top:10px;}
#battleLog{max-height:200px;overflow-y:auto;border:1px solid #fff;padding:6px;margin-top:10px;border-radius:6px;background:#1a202c;}
</style>
<script>
let deferredPrompt;
if("serviceWorker" in navigator){navigator.serviceWorker.register("service-worker.js");}

window.addEventListener("beforeinstallprompt",(e)=>{
    e.preventDefault();
    deferredPrompt = e;
});

function installApp(){
    if(deferredPrompt){
        deferredPrompt.prompt();
        deferredPrompt.userChoice.finally(()=>deferredPrompt=null);
    } else {
        alert(
            "iOS: Tap the Share button → 'Add to Home Screen'.\n" +
            "Android: Open this page via HTTPS; the install prompt should appear automatically."
        );
    }
    document.getElementById("installBtn").disabled=false;
}

function switchTab(tabId){
    document.querySelectorAll("section").forEach(sec=>sec.classList.remove("active"));
    document.getElementById(tabId).classList.add("active");
    document.querySelectorAll(".tab-button").forEach(btn=>btn.setAttribute("aria-selected","false"));
    document.querySelector(`[data-tab='${tabId}']`).setAttribute("aria-selected","true");
    document.getElementById("liveRegion").innerText = tabId.charAt(0).toUpperCase()+tabId.slice(1)+" tab selected";
}

window.onload = ()=>{switchTab("home");loadGame();renderTabs();};

// Pokémon list (first 340 for now)
let pokemonList=[
"Bulbasaur","Ivysaur","Venusaur","Charmander","Charmeleon","Charizard","Squirtle","Wartortle","Blastoise","Caterpie",
"Metapod","Butterfree","Weedle","Kakuna","Beedrill","Pidgey","Pidgeotto","Pidgeot","Rattata","Raticate",
"Spearow","Fearow","Ekans","Arbok","Pikachu","Raichu","Sandshrew","Sandslash","Nidoran♀","Nidorina",
"Nidoqueen","Nidoran♂","Nidorino","Nidoking","Clefairy","Clefable","Vulpix","Ninetales","Jigglypuff","Wigglytuff",
"Zubat","Golbat","Oddish","Gloom","Vileplume","Paras","Parasect","Venonat","Venomoth","Diglett",
"Dugtrio","Meowth","Persian","Psyduck","Golduck","Mankey","Primeape","Growlithe","Arcanine","Poliwag",
"Poliwhirl","Poliwrath","Abra","Kadabra","Alakazam","Machop","Machoke","Machamp","Bellsprout","Weepinbell",
// ... continue up to 340 Pokémon
];

// Game data
let pokedex=[],items={Potion:0,"Poké Ball":0,"Rare Candy":0},achievements={};
function saveGame(){
    localStorage.setItem("pokedex",JSON.stringify(pokedex));
    localStorage.setItem("items",JSON.stringify(items));
    localStorage.setItem("achievements",JSON.stringify(achievements));
}
function loadGame(){
    pokedex=JSON.parse(localStorage.getItem("pokedex"))||[];
    items=JSON.parse(localStorage.getItem("items"))||{Potion:0,"Poké Ball":0,"Rare Candy":0};
    achievements=JSON.parse(localStorage.getItem("achievements"))||{};
    renderPokedex();updateAchievements();
}

function speak(text){if("speechSynthesis" in window){let u=new SpeechSynthesisUtterance(text);speechSynthesis.speak(u);}}
function announce(text){document.getElementById("liveRegion").innerText=text;}

function renderPokedex(){
    let container=document.getElementById("pokedex");container.innerHTML="";
    pokemonList.forEach(p=>{
        let div=document.createElement("div");div.className="card";div.textContent=pokedex.includes(p)?p:"???";container.appendChild(div);
    });
}

function catchPokemon(){
    let found=pokemonList[Math.floor(Math.random()*pokemonList.length)];
    if(!pokedex.includes(found)) pokedex.push(found);
    saveGame();renderPokedex();
    speak("You found "+found);announce("You found "+found);
    updateAchievements();
}

function updateAchievements(){
    let count=pokedex.length;let newAchieve=[];
    if(count>=5&&!achievements.Novice){achievements.Novice=true;newAchieve.push("Novice Collector");}
    if(count>=10&&!achievements.Collector){achievements.Collector=true;newAchieve.push("Collector");}
    if(count>=20&&!achievements.Expert){achievements.Expert=true;newAchieve.push("Expert Collector");}
    saveGame();
    if(newAchieve.length>0){newAchieve.forEach(a=>speak("Achievement unlocked: "+a));announce("Achievements unlocked: "+newAchieve.join(", "));}
}

function dailyReward(){
    let lastClaim=localStorage.getItem("lastDaily");
    let today=new Date().toDateString();
    if(lastClaim===today){alert("Daily reward already claimed!");return;}
    let reward=pokemonList[Math.floor(Math.random()*pokemonList.length)];
    if(!pokedex.includes(reward)) pokedex.push(reward);
    items.Potion+=1;
    localStorage.setItem("lastDaily",today);
    saveGame();renderPokedex();
    speak("Daily reward: "+reward+" and 1 Potion!");announce("Daily reward: "+reward+" and 1 Potion!");
    updateAchievements();
}

function exportPokedex(){
    document.getElementById("exportData").value=JSON.stringify(pokedex);
    announce("Pokédex exported.");
}

function importPokedex(){
    let data=document.getElementById("importData").value;
    try{
        let imported=JSON.parse(data);let added=0;
        imported.forEach(p=>{if(!pokedex.includes(p)){pokedex.push(p);added++;}});
        saveGame();renderPokedex();announce("Pokédex updated. "+added+" new Pokémon added.");speak(added+" new Pokémon added.");updateAchievements();
    }catch(e){alert("Invalid data!");}
}

function renderTabs(){
    document.getElementById("catchBtn").onclick=catchPokemon;
    document.getElementById("dailyRewardBtn").onclick=dailyReward;
    document.getElementById("exportBtn").onclick=exportPokedex;
    document.getElementById("importBtn").onclick=importPokedex;
    document.getElementById("startBattleBtn").onclick=startBattle;
}

//////////////////// BATTLE SYSTEM ////////////////////
let battleState={player:null,opponent:null,playerHP:0,opponentHP:0,turn:"player"};
function startBattle(){
    if(pokedex.length===0){alert("You have no Pokémon to battle with!");return;}
    switchTab("battle");
    renderBattleSelection();
}

function renderBattleSelection(){
    let battleArea=document.getElementById("battleArea");
    battleArea.innerHTML="<h3>Select your Pokémon:</h3>";
    let select=document.createElement("select");select.id="battleSelect";
    pokedex.forEach(p=>{
        let opt=document.createElement("option");