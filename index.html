<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Madden Game</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM CDNs -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Firebase CDNs for Firestore -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            getFirestore,
            doc,
            setDoc,
            onSnapshot
        };
    </script>
    <style>
        /* Global styles for the body */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        /* Main container for the app */
        .main-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            z-index: 10;
        }
        /* Background animation */
        .bg-animation {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(-45deg, #2b6cb0, #4299e1, #3182ce, #1c3d5a);
            background-size: 400% 400%;
            animation: gradient-shift 15s ease infinite;
            z-index: 1;
        }
        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        /* Styles for the menu cards */
        .menu-card, .quick-play-card {
            background-color: rgba(26, 32, 44, 0.9);
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 90%;
            width: 100%;
            max-width: 450px;
        }
        /* Title style */
        .menu-title {
            font-size: 2.25rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 1.5rem;
            color: #63b3ed;
        }
        /* Base button styles */
        .menu-base-button {
            width: 100%;
            padding: 1rem 2rem;
            margin-bottom: 1rem;
            border-radius: 0.75rem;
            font-size: 1.125rem;
            font-weight: 700;
            color: #ffffff;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            border: none;
        }
        .menu-base-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .menu-base-button:active {
            transform: translateY(1px);
            box-shadow: none;
        }
        /* Specific button styles */
        .quick-play-button { background: linear-gradient(135deg, #4299e1, #3182ce); }
        .franchise-button { background: linear-gradient(135deg, #63b3ed, #4a91c6); }
        .settings-button { background: linear-gradient(135deg, #a0aec0, #718096); }
        .exit-button { background: linear-gradient(135deg, #f56565, #e53e3e); }
        .menu-button {
            width: 100%;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            font-size: 1.125rem;
            font-weight: 700;
            color: #ffffff;
            background: linear-gradient(135deg, #4299e1, #3182ce);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            border: none;
        }
        .menu-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .menu-button:active {
            transform: translateY(1px);
            box-shadow: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        const { useState, useEffect, useRef } = React;
        const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, setDoc, onSnapshot } = window.firebase;

        // --- Helper functions for audio processing ---
        const base64ToArrayBuffer = (base64) => {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        };

        const pcmToWav = (pcm16, sampleRate) => {
            const numChannels = 1;
            const bitsPerSample = 16;
            const byteRate = (sampleRate * numChannels * bitsPerSample) / 8;
            const blockAlign = (numChannels * bitsPerSample) / 8;
            const dataLength = pcm16.length * 2;
            const buffer = new ArrayBuffer(44 + dataLength);
            const view = new DataView(buffer);
            let offset = 0;
            const writeString = (str) => {
                for (let i = 0; i < str.length; i++) { view.setUint8(offset++, str.charCodeAt(i)); }
            };
            writeString('RIFF');
            view.setUint32(offset, 36 + dataLength, true); offset += 4;
            writeString('WAVE');
            writeString('fmt ');
            view.setUint32(offset, 16, true); offset += 4;
            view.setUint16(offset, 1, true); offset += 2;
            view.setUint16(offset, numChannels, true); offset += 2;
            view.setUint32(offset, sampleRate, true); offset += 4;
            view.setUint32(offset, byteRate, true); offset += 4;
            view.setUint16(offset, blockAlign, true); offset += 2;
            view.setUint16(offset, bitsPerSample, true); offset += 2;
            writeString('data');
            view.setUint32(offset, dataLength, true); offset += 4;
            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(offset, pcm16[i], true);
                offset += 2;
            }
            return new Blob([view], { type: 'audio/wav' });
        };
        
        const playTts = async (text, audioPlayerRef) => {
            if (audioPlayerRef.current) {
                audioPlayerRef.current.pause();
                audioPlayerRef.current.removeAttribute('src');
                audioPlayerRef.current.load();
            }
            const payload = {
                contents: [{ parts: [{ text: text }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: { prebuiltVoiceConfig: { voiceName: "Rasalgethi" } }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;
                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    audioPlayerRef.current.src = audioUrl;
                    audioPlayerRef.current.play();
                } else {
                    console.error("TTS API response error:", result);
                }
            } catch (e) {
                console.error("TTS API call failed:", e);
            }
        };

        // --- Main App component ---
        const App = () => {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [userId, setUserId] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [page, setPage] = useState('main-menu');
            const [franchiseData, setFranchiseData] = useState(null);
            const [franchisePage, setFranchisePage] = useState('hub');
            const [error, setError] = useState(null);
            const audioPlayer = useRef(null);
            
            useEffect(() => {
                const initFirebase = async () => {
                    try {
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        
                        const app = initializeApp(firebaseConfig);
                        const firestoreDb = getFirestore(app);
                        const firebaseAuth = getAuth(app);
                        setDb(firestoreDb);
                        setAuth(firebaseAuth);

                        const unsubscribe = onAuthStateChanged(firebaseAuth, async (user) => {
                            if (user) { setUserId(user.uid); }
                            else { await signInAnonymously(firebaseAuth); }
                            setIsLoading(false);
                        });

                        if (initialAuthToken) { await signInWithCustomToken(firebaseAuth, initialAuthToken); }
                        return () => unsubscribe();
                    } catch (err) {
                        console.error("Firebase initialization or auth failed:", err);
                        setError("Failed to initialize the app. Please try again.");
                        setIsLoading(false);
                    }
                };
                initFirebase();
            }, []);

            useEffect(() => {
                if (!db || !userId) return;
                const franchiseDocPath = `artifacts/${__app_id}/users/${userId}/franchise/myFranchise`;
                const franchiseDocRef = doc(db, franchiseDocPath);
                const unsubscribe = onSnapshot(franchiseDocRef, (docSnap) => {
                    if (docSnap.exists()) { setFranchiseData(docSnap.data()); }
                    else { setFranchiseData(null); }
                }, (err) => {
                    console.error("Error fetching franchise data:", err);
                    setError("Failed to load franchise data. Please check your network connection.");
                });
                return () => unsubscribe();
            }, [db, userId]);

            const LoadingScreen = () => {
                return React.createElement('div', { className: 'flex justify-center items-center h-screen bg-gray-900 text-white' },
                    React.createElement('div', { className: 'animate-pulse text-lg' }, 'Loading...')
                );
            };

            const MessageBox = ({ message, onClose }) => {
                return React.createElement('div', { className: 'fixed inset-0 bg-gray-900 bg-opacity-70 flex justify-center items-center z-50' },
                    React.createElement('div', { className: 'bg-gray-800 p-8 rounded-xl shadow-lg w-11/12 md:w-1/3 text-center' },
                        React.createElement('p', { className: 'text-xl mb-4' }, message),
                        React.createElement('button', { onClick: onClose, className: 'bg-blue-600 text-white py-2 px-6 rounded-lg hover:bg-blue-700' }, 'OK')
                    )
                );
            };

            const MainMenu = () => {
                const [message, setMessage] = useState(null);
                const showMessage = (msg) => { setMessage(msg); };
                const handleButtonClick = (action) => {
                    if (action === 'quick-play') { setPage('quick-play'); }
                    else if (action === 'franchise') { userId ? setPage('franchise') : showMessage("Authenticating... Please wait."); }
                    else { showMessage(`"${action.replace('-', ' ')}" is not yet implemented.`); }
                };
                return React.createElement('div', { className: 'menu-card' },
                    React.createElement('h1', { className: 'menu-title' }, 'My Madden Game'),
                    React.createElement('div', { className: 'flex flex-col space-y-4' },
                        React.createElement('button', { onClick: () => handleButtonClick('quick-play'), className: 'menu-base-button quick-play-button' }, 'Quick Play'),
                        React.createElement('button', { onClick: () => handleButtonClick('franchise'), className: 'menu-base-button franchise-button' }, 'Franchise Mode'),
                        React.createElement('button', { onClick: () => handleButtonClick('settings'), className: 'menu-base-button settings-button' }, 'Settings'),
                        React.createElement('button', { onClick: () => showMessage("Exiting... just kidding! You're in a browser."), className: 'menu-base-button exit-button' }, 'Exit Game')
                    ),
                    message && React.createElement(MessageBox, { message: message, onClose: () => setMessage(null) })
                );
            };

            const QuickPlay = () => {
                const [message, setMessage] = useState(null);
                const teams = [
                    'Kansas City Chiefs', 'San Francisco 49ers', 'Buffalo Bills', 'Dallas Cowboys',
                    'Philadelphia Eagles', 'Green Bay Packers', 'New Orleans Saints', 'New York Jets',
                    'New England Patriots', 'Las Vegas Raiders', 'Miami Dolphins', 'Detroit Lions',
                    'Baltimore Ravens', 'Cincinnati Bengals', 'Los Angeles Rams', 'Atlanta Falcons'
                ];
                const handlePlayGame = () => {
                    const homeTeam = document.getElementById('team-1').value;
                    const awayTeam = document.getElementById('team-2').value;
                    if (homeTeam === awayTeam) {
                        setMessage("You must select two different teams to play a game.");
                        return;
                    }
                    const quarterLength = document.getElementById('quarter-length').value;
                    const difficulty = document.getElementById('difficulty').value;
                    const gameStyle = document.getElementById('game-style').value;
                    const eventType = document.getElementById('event-type').value;
                    const gameInfo = `A game between the ${homeTeam} and the ${awayTeam} is about to begin! - Quarter Length: ${quarterLength} minutes - Difficulty: ${difficulty} - Game Style: ${gameStyle} - Event Type: ${eventType}`;
                    setMessage(gameInfo);
                };
                return React.createElement('div', { className: 'quick-play-card' },
                    React.createElement('h1', { className: 'menu-title' }, 'Quick Play'),
                    React.createElement('div', { className: 'space-y-6' },
                        React.createElement('div', { className: 'flex flex-col md:flex-row items-center justify-between space-y-4 md:space-y-0 md:space-x-4' },
                            React.createElement('div', { className: 'w-full md:w-1/2' },
                                React.createElement('label', { htmlFor: 'team-1', className: 'block text-lg font-semibold mb-2' }, 'Home Team:'),
                                React.createElement('select', { id: 'team-1', className: 'w-full p-3 rounded-lg bg-gray-700 text-white border-none focus:outline-none focus:ring-2 focus:ring-blue-500' },
                                    teams.map(team => React.createElement('option', { key: team, value: team }, team))
                                )
                            ),
                            React.createElement('div', { className: 'text-xl font-bold' }, 'VS'),
                            React.createElement('div', { className: 'w-full md:w-1/2' },
                                React.createElement('label', { htmlFor: 'team-2', className: 'block text-lg font-semibold mb-2' }, 'Away Team:'),
                                React.createElement('select', { id: 'team-2', className: 'w-full p-3 rounded-lg bg-gray-700 text-white border-none focus:outline-none focus:ring-2 focus:ring-blue-500' },
                                    teams.map(team => React.createElement('option', { key: team, value: team }, team))
                                )
                            )
                        ),
                        React.createElement('div', { className: 'mt-8 grid grid-cols-1 md:grid-cols-2 gap-4' },
                            React.createElement('div', null,
                                React.createElement('label', { htmlFor: 'quarter-length', className: 'block font-semibold mb-2' }, 'Quarter Length:'),
                                React.createElement('select', { id: 'quarter-length', className: 'w-full p-3 rounded-lg bg-gray-700 text-white border-none focus:outline-none focus:ring-2 focus:ring-blue-500' },
                                    React.createElement('option', { value: '5' }, '5 Minutes'),
                                    React.createElement('option', { value: '8' }, '8 Minutes'),
                                    React.createElement('option', { value: '10' }, '10 Minutes'),
                                    React.createElement('option', { value: '15' }, '15 Minutes')
                                )
                            ),
                            React.createElement('div', null,
                                React.createElement('label', { htmlFor: 'difficulty', className: 'block font-semibold mb-2' }, 'Difficulty:'),
                                React.createElement('select', { id: 'difficulty', className: 'w-full p-3 rounded-lg bg-gray-700 text-white border-none focus:outline-none focus:ring-2 focus:ring-blue-500' },
                                    React.createElement('option', { value: 'rookie' }, 'Rookie'),
                                    React.createElement('option', { value: 'pro' }, 'Pro'),
                                    React.createElement('option', { value: 'all-pro' }, 'All-Pro'),
                                    React.createElement('option', { value: 'all-madden' }, 'All-Madden')
                                )
                            ),
                            React.createElement('div', null,
                                React.createElement('label', { htmlFor: 'game-style', className: 'block font-semibold mb-2' }, 'Game Style:'),
                                React.createElement('select', { id: 'game-style', className: 'w-full p-3 rounded-lg bg-gray-700 text-white border-none focus:outline-none focus:ring-2 focus:ring-blue-500' },
                                    React.createElement('option', { value: 'simulation' }, 'Simulation'),
                                    React.createElement('option', { value: 'competitive' }, 'Competitive'),
                                    React.createElement('option', { value: 'arcade' }, 'Arcade')
                                )
                            ),
                            React.createElement('div', null,
                                React.createElement('label', { htmlFor: 'event-type', className: 'block font-semibold mb-2' }, 'Event Type:'),
                                React.createElement('select', { id: 'event-type', className: 'w-full p-3 rounded-lg bg-gray-700 text-white border-none focus:outline-none focus:ring-2 focus:ring-blue-500' },
                                    React.createElement('option', { value: 'exhibition' }, 'Exhibition'),
                                    React.createElement('option', { value: 'pro-bowl' }, 'Pro Bowl'),
                                    React.createElement('option', { value: 'super-bowl' }, 'Super Bowl')
                                )
                            )
                        )
                    ),
                    React.createElement('div', { className: 'flex flex-col mt-8 space-y-4' },
                        React.createElement('button', { onClick: handlePlayGame, className: 'menu-button' }, 'Play Game'),
                        React.createElement('button', { onClick: () => setPage('main-menu'), className: 'menu-button bg-gray-700 hover:bg-gray-600' }, 'Back')
                    ),
                    message && React.createElement(MessageBox, { message: message, onClose: () => setMessage(null) })
                );
            };

            const NewFranchise = () => {
                const [selectedTeam, setSelectedTeam] = useState('Kansas City Chiefs');
                const [message, setMessage] = useState(null);
                const teams = [
                    'Kansas City Chiefs', 'San Francisco 49ers', 'Buffalo Bills', 'Dallas Cowboys',
                    'Philadelphia Eagles', 'Green Bay Packers', 'New Orleans Saints', 'New York Jets',
                    'New England Patriots', 'Las Vegas Raiders', 'Miami Dolphins', 'Detroit Lions',
                    'Baltimore Ravens', 'Cincinnati Bengals', 'Los Angeles Rams', 'Atlanta Falcons'
                ];
                const handleCreateFranchise = async () => {
                    if (!db || !userId) {
                        setMessage("Database not ready. Please try again in a moment.");
                        return;
                    }
                    try {
                        const franchiseDocPath = `artifacts/${__app_id}/users/${userId}/franchise/myFranchise`;
                        const franchiseDocRef = doc(db, franchiseDocPath);
                        const newFranchiseData = {
                            teamName: selectedTeam,
                            season: 1,
                            wins: 0,
                            losses: 0,
                            createdAt: new Date().toISOString()
                        };
                        await setDoc(franchiseDocRef, newFranchiseData);
                        setMessage("New franchise created successfully!");
                        setFranchisePage('hub');
                    } catch (e) {
                        console.error("Error creating franchise:", e);
                        setMessage("Failed to create franchise. Please try again.");
                    }
                };
                return React.createElement('div', { className: 'quick-play-card' },
                    React.createElement('h1', { className: 'menu-title' }, 'New Franchise'),
                    React.createElement('div', { className: 'space-y-4' },
                        React.createElement('div', null,
                            React.createElement('label', { htmlFor: 'franchise-team', className: 'block text-lg font-semibold mb-2' }, 'Select Your Team:'),
                            React.createElement('select', { id: 'franchise-team', value: selectedTeam, onChange: (e) => setSelectedTeam(e.target.value), className: 'w-full p-3 rounded-lg bg-gray-700 text-white border-none focus:outline-none focus:ring-2 focus:ring-blue-500' },
                                teams.map(team => React.createElement('option', { key: team, value: team }, team))
                            )
                        ),
                        React.createElement('button', { onClick: handleCreateFranchise, className: 'menu-button' }, 'Create Franchise')
                    ),
                    React.createElement('div', { className: 'flex flex-col mt-8 space-y-4' },
                        React.createElement('button', { onClick: () => setFranchisePage('hub'), className: 'menu-button bg-gray-700 hover:bg-gray-600' }, 'Back')
                    ),
                    message && React.createElement(MessageBox, { message: message, onClose: () => setMessage(null) })
                );
            };

            const FranchiseHub = () => {
                const [message, setMessage] = useState(null);
                const handleTestCommentary = () => {
                    const commentary = "First and ten, ball on the twenty-five yard line. The quarterback is in shotgun formation.";
                    playTts(commentary, audioPlayer);
                    setMessage("Playing commentary... Listen closely!");
                };
                return React.createElement('div', { className: 'quick-play-card' },
                    React.createElement('h1', { className: 'menu-title' }, 'Franchise Hub'),
                    error ? (
                        React.createElement('div', { className: 'text-red-400' }, error)
                    ) : franchiseData ? (
                        React.createElement('div', { className: 'space-y-4' },
                            React.createElement('p', { className: 'text-center' }, 'Welcome, ', React.createElement('span', { className: 'font-bold' }, franchiseData.teamName), ' fan!'),
                            React.createElement('p', { className: 'text-center text-sm text-gray-400 break-words' }, 'User ID: ', userId),
                            React.createElement('div', { className: 'mt-4 p-4 bg-gray-700 rounded-lg' },
                                React.createElement('h2', { className: 'text-lg font-semibold text-center mb-2' }, 'Franchise Info'),
                                React.createElement('p', null, 'Season: ', franchiseData.season),
                                React.createElement('p', null, 'Record: ', franchiseData.wins, ' - ', franchiseData.losses)
                            ),
                            React.createElement('button', { onClick: handleTestCommentary, className: 'menu-button mt-4' }, 'Test Commentary')
                        )
                    ) : (
                        React.createElement('div', { className: 'space-y-4 text-center' },
                            React.createElement('p', null, 'No franchise found. Start a new one to begin your journey!'),
                            React.createElement('button', { onClick: () => setFranchisePage('new-franchise'), className: 'menu-button' }, 'Start New Franchise')
                        )
                    ),
                    React.createElement('div', { className: 'flex flex-col mt-8 space-y-4' },
                        React.createElement('button', { onClick: () => setPage('main-menu'), className: 'menu-button bg-gray-700 hover:bg-gray-600' }, 'Back')
                    ),
                    message && React.createElement(MessageBox, { message: message, onClose: () => setMessage(null) }),
                    React.createElement('audio', { ref: audioPlayer })
                );
            };

            const AppRender = () => {
                const [page, setPage] = useState('main-menu');
                const [franchisePage, setFranchisePage] = useState('hub');
                const [db, setDb] = useState(null);
                const [auth, setAuth] = useState(null);
                const [userId, setUserId] = useState(null);
                const [isLoading, setIsLoading] = useState(true);
                const [franchiseData, setFranchiseData] = useState(null);
                const [error, setError] = useState(null);
                const audioPlayer = useRef(null);

                useEffect(() => {
                    const initFirebase = async () => {
                        try {
                            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                            const app = initializeApp(firebaseConfig);
                            const firestoreDb = getFirestore(app);
                            const firebaseAuth = getAuth(app);
                            setDb(firestoreDb);
                            setAuth(firebaseAuth);

                            const unsubscribe = onAuthStateChanged(firebaseAuth, async (user) => {
                                if (user) { setUserId(user.uid); }
                                else { await signInAnonymously(firebaseAuth); }
                                setIsLoading(false);
                            });
                            if (initialAuthToken) { await signInWithCustomToken(firebaseAuth, initialAuthToken); }
                            return () => unsubscribe();
                        } catch (err) {
                            console.error("Firebase initialization or auth failed:", err);
                            setError("Failed to initialize the app. Please try again.");
                            setIsLoading(false);
                        }
                    };
                    initFirebase();
                }, []);

                useEffect(() => {
                    if (!db || !userId) return;
                    const franchiseDocPath = `artifacts/${__app_id}/users/${userId}/franchise/myFranchise`;
                    const franchiseDocRef = doc(db, franchiseDocPath);
                    const unsubscribe = onSnapshot(franchiseDocRef, (docSnap) => {
                        if (docSnap.exists()) { setFranchiseData(docSnap.data()); }
                        else { setFranchiseData(null); }
                    }, (err) => {
                        console.error("Error fetching franchise data:", err);
                        setError("Failed to load franchise data. Please check your network connection.");
                    });
                    return () => unsubscribe();
                }, [db, userId]);

                if (isLoading) {
                    return React.createElement(LoadingScreen, null);
                }

                let pageContent;
                switch (page) {
                    case 'main-menu':
                        pageContent = React.createElement(MainMenu, { setPage, userId });
                        break;
                    case 'quick-play':
                        pageContent = React.createElement(QuickPlay, { setPage });
                        break;
                    case 'franchise':
                        if (franchisePage === 'new-franchise') {
                            pageContent = React.createElement(NewFranchise, { setFranchisePage, db, userId });
                        } else {
                            pageContent = React.createElement(FranchiseHub, { setPage, setFranchisePage, franchiseData, userId, error, audioPlayer });
                        }
                        break;
                    default:
                        pageContent = React.createElement(MainMenu, { setPage, userId });
                }
                return React.createElement('div', { className: 'relative min-h-screen bg-gray-900 text-white font-sans' },
                    React.createElement('div', { className: 'bg-animation' }),
                    React.createElement('div', { className: 'main-container' }, pageContent)
                );
            };
            
            ReactDOM.render(
                React.createElement(AppRender),
                document.getElementById('root')
            );
        </script>
    </body>
</html>