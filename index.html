<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Madden Game</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase CDNs for Firestore -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            getFirestore,
            doc,
            setDoc,
            onSnapshot
        };
    </script>
    <style>
        /* Global styles for the body */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        /* Main container for the app */
        .main-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            z-index: 10;
        }
        /* Background animation */
        .bg-animation {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(-45deg, #2b6cb0, #4299e1, #3182ce, #1c3d5a);
            background-size: 400% 400%;
            animation: gradient-shift 15s ease infinite;
            z-index: 1;
        }
        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        /* Styles for the menu cards */
        .menu-card, .quick-play-card {
            background-color: rgba(26, 32, 44, 0.9);
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 90%;
            width: 100%;
            max-width: 450px;
        }
        /* Title style */
        .menu-title {
            font-size: 2.25rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 1.5rem;
            color: #63b3ed;
        }
        /* Base button styles */
        .menu-base-button {
            width: 100%;
            padding: 1rem 2rem;
            margin-bottom: 1rem;
            border-radius: 0.75rem;
            font-size: 1.125rem;
            font-weight: 700;
            color: #ffffff;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            border: none;
        }
        .menu-base-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .menu-base-button:active {
            transform: translateY(1px);
            box-shadow: none;
        }
        /* Specific button styles */
        .quick-play-button { background: linear-gradient(135deg, #4299e1, #3182ce); }
        .franchise-button { background: linear-gradient(135deg, #63b3ed, #4a91c6); }
        .settings-button { background: linear-gradient(135deg, #a0aec0, #718096); }
        .exit-button { background: linear-gradient(135deg, #f56565, #e53e3e); }
        .menu-button {
            width: 100%;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            font-size: 1.125rem;
            font-weight: 700;
            color: #ffffff;
            background: linear-gradient(135deg, #4299e1, #3182ce);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            border: none;
        }
        .menu-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .menu-button:active {
            transform: translateY(1px);
            box-shadow: none;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="bg-animation"></div>
        <div id="app"></div>
    </div>
    
    <script>
        // Global state variables
        let db;
        let auth;
        let userId = null;
        let franchiseData = null;
        let currentPage = 'main-menu';
        let currentFranchisePage = 'hub';
        const audioPlayer = new Audio();
        
        // --- Helper functions for audio processing ---
        const base64ToArrayBuffer = (base64) => {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        };

        const pcmToWav = (pcm16, sampleRate) => {
            const numChannels = 1;
            const bitsPerSample = 16;
            const byteRate = (sampleRate * numChannels * bitsPerSample) / 8;
            const blockAlign = (numChannels * bitsPerSample) / 8;
            const dataLength = pcm16.length * 2;
            const buffer = new ArrayBuffer(44 + dataLength);
            const view = new DataView(buffer);
            let offset = 0;
            const writeString = (str) => {
                for (let i = 0; i < str.length; i++) { view.setUint8(offset++, str.charCodeAt(i)); }
            };
            writeString('RIFF');
            view.setUint32(offset, 36 + dataLength, true); offset += 4;
            writeString('WAVE');
            writeString('fmt ');
            view.setUint32(offset, 16, true); offset += 4;
            view.setUint16(offset, 1, true); offset += 2;
            view.setUint16(offset, numChannels, true); offset += 2;
            view.setUint32(offset, sampleRate, true); offset += 4;
            view.setUint32(offset, byteRate, true); offset += 4;
            view.setUint16(offset, blockAlign, true); offset += 2;
            view.setUint16(offset, bitsPerSample, true); offset += 2;
            writeString('data');
            view.setUint32(offset, dataLength, true); offset += 4;
            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(offset, pcm16[i], true);
                offset += 2;
            }
            return new Blob([view], { type: 'audio/wav' });
        };
        
        const playTts = async (text) => {
            audioPlayer.pause();
            audioPlayer.removeAttribute('src');
            audioPlayer.load();

            const payload = {
                contents: [{ parts: [{ text: text }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: { prebuiltVoiceConfig: { voiceName: "Rasalgethi" } }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;
                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    audioPlayer.src = audioUrl;
                    audioPlayer.play();
                } else {
                    console.error("TTS API response error:", result);
                }
            } catch (e) {
                console.error("TTS API call failed:", e);
            }
        };

        // --- DOM Manipulation Functions ---
        const showMessageBox = (message, onCloseCallback) => {
            const appDiv = document.getElementById('app');
            const messageBoxHTML = `
                <div id="messageBox" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex justify-center items-center z-50">
                    <div class="bg-gray-800 p-8 rounded-xl shadow-lg w-11/12 md:w-1/3 text-center">
                        <p class="text-xl mb-4">${message}</p>
                        <button id="okButton" class="bg-blue-600 text-white py-2 px-6 rounded-lg hover:bg-blue-700">OK</button>
                    </div>
                </div>
            `;
            const messageBoxContainer = document.createElement('div');
            messageBoxContainer.innerHTML = messageBoxHTML;
            appDiv.appendChild(messageBoxContainer);
            
            document.getElementById('okButton').addEventListener('click', () => {
                appDiv.removeChild(messageBoxContainer);
                if (onCloseCallback) onCloseCallback();
            });
        };

        const renderMainMenu = () => {
            const appDiv = document.getElementById('app');
            appDiv.innerHTML = `
                <div class="menu-card">
                    <h1 class="menu-title">My Madden Game</h1>
                    <div class="flex flex-col space-y-4">
                        <button id="quickPlayBtn" class="menu-base-button quick-play-button">Quick Play</button>
                        <button id="franchiseBtn" class="menu-base-button franchise-button">Franchise Mode</button>
                        <button id="settingsBtn" class="menu-base-button settings-button">Settings</button>
                        <button id="exitBtn" class="menu-base-button exit-button">Exit Game</button>
                    </div>
                </div>
            `;
            
            document.getElementById('quickPlayBtn').addEventListener('click', () => {
                currentPage = 'quick-play';
                renderPage();
            });
            document.getElementById('franchiseBtn').addEventListener('click', () => {
                if (userId) {
                    currentPage = 'franchise';
                    currentFranchisePage = franchiseData ? 'hub' : 'new-franchise';
                    renderPage();
                } else {
                    showMessageBox("Authenticating... Please wait.");
                }
            });
            document.getElementById('settingsBtn').addEventListener('click', () => {
                showMessageBox('"Settings" is not yet implemented.');
            });
            document.getElementById('exitBtn').addEventListener('click', () => {
                showMessageBox("Exiting... just kidding! You're in a browser.");
            });
        };
        
        const renderQuickPlay = () => {
            const appDiv = document.getElementById('app');
            const teams = [
                'Kansas City Chiefs', 'San Francisco 49ers', 'Buffalo Bills', 'Dallas Cowboys',
                'Philadelphia Eagles', 'Green Bay Packers', 'New Orleans Saints', 'New York Jets',
                'New England Patriots', 'Las Vegas Raiders', 'Miami Dolphins', 'Detroit Lions',
                'Baltimore Ravens', 'Cincinnati Bengals', 'Los Angeles Rams', 'Atlanta Falcons'
            ];
            const teamOptions = teams.map(team => `<option value="${team}">${team}</option>`).join('');

            appDiv.innerHTML = `
                <div class="quick-play-card">
                    <h1 class="menu-title">Quick Play</h1>
                    <div class="space-y-6">
                        <div class="flex flex-col md:flex-row items-center justify-between space-y-4 md:space-y-0 md:space-x-4">
                            <div class="w-full md:w-1/2">
                                <label for="team-1" class="block text-lg font-semibold mb-2">Home Team:</label>
                                <select id="team-1" class="w-full p-3 rounded-lg bg-gray-700 text-white border-none focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    ${teamOptions}
                                </select>
                            </div>
                            <div class="text-xl font-bold">VS</div>
                            <div class="w-full md:w-1/2">
                                <label for="team-2" class="block text-lg font-semibold mb-2">Away Team:</label>
                                <select id="team-2" class="w-full p-3 rounded-lg bg-gray-700 text-white border-none focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    ${teamOptions}
                                </select>
                            </div>
                        </div>
                        <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="quarter-length" class="block font-semibold mb-2">Quarter Length:</label>
                                <select id="quarter-length" class="w-full p-3 rounded-lg bg-gray-700 text-white border-none focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="5">5 Minutes</option>
                                    <option value="8">8 Minutes</option>
                                    <option value="10">10 Minutes</option>
                                    <option value="15">15 Minutes</option>
                                </select>
                            </div>
                            <div>
                                <label for="difficulty" class="block font-semibold mb-2">Difficulty:</label>
                                <select id="difficulty" class="w-full p-3 rounded-lg bg-gray-700 text-white border-none focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="rookie">Rookie</option>
                                    <option value="pro">Pro</option>
                                    <option value="all-pro">All-Pro</option>
                                    <option value="all-madden">All-Madden</option>
                                </select>
                            </div>
                            <div>
                                <label for="game-style" class="block font-semibold mb-2">Game Style:</label>
                                <select id="game-style" class="w-full p-3 rounded-lg bg-gray-700 text-white border-none focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="simulation">Simulation</option>
                                    <option value="competitive">Competitive</option>
                                    <option value="arcade">Arcade</option>
                                </select>
                            </div>
                            <div>
                                <label for="event-type" class="block font-semibold mb-2">Event Type:</label>
                                <select id="event-type" class="w-full p-3 rounded-lg bg-gray-700 text-white border-none focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="exhibition">Exhibition</option>
                                    <option value="pro-bowl">Pro Bowl</option>
                                    <option value="super-bowl">Super Bowl</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col mt-8 space-y-4">
                        <button id="playGameBtn" class="menu-button">Play Game</button>
                        <button id="backToMainBtn" class="menu-button bg-gray-700 hover:bg-gray-600">Back</button>
                    </div>
                </div>
            `;

            document.getElementById('playGameBtn').addEventListener('click', () => {
                const homeTeam = document.getElementById('team-1').value;
                const awayTeam = document.getElementById('team-2').value;
                if (homeTeam === awayTeam) {
                    showMessageBox("You must select two different teams to play a game.");
                    return;
                }
                const quarterLength = document.getElementById('quarter-length').value;
                const difficulty = document.getElementById('difficulty').value;
                const gameStyle = document.getElementById('game-style').value;
                const eventType = document.getElementById('event-type').value;
                const gameInfo = `A game between the ${homeTeam} and the ${awayTeam} is about to begin!
                - Quarter Length: ${quarterLength} minutes
                - Difficulty: ${difficulty}
                - Game Style: ${gameStyle}
                - Event Type: ${eventType}`;
                showMessageBox(gameInfo);
            });
            document.getElementById('backToMainBtn').addEventListener('click', () => {
                currentPage = 'main-menu';
                renderPage();
            });
        };

        const renderNewFranchise = () => {
            const appDiv = document.getElementById('app');
            const teams = [
                'Kansas City Chiefs', 'San Francisco 49ers', 'Buffalo Bills', 'Dallas Cowboys',
                'Philadelphia Eagles', 'Green Bay Packers', 'New Orleans Saints', 'New York Jets',
                'New England Patriots', 'Las Vegas Raiders', 'Miami Dolphins', 'Detroit Lions',
                'Baltimore Ravens', 'Cincinnati Bengals', 'Los Angeles Rams', 'Atlanta Falcons'
            ];
            const teamOptions = teams.map(team => `<option value="${team}">${team}</option>`).join('');
            
            appDiv.innerHTML = `
                <div class="quick-play-card">
                    <h1 class="menu-title">New Franchise</h1>
                    <div class="space-y-4">
                        <div>
                            <label for="franchise-team" class="block text-lg font-semibold mb-2">Select Your Team:</label>
                            <select id="franchise-team" class="w-full p-3 rounded-lg bg-gray-700 text-white border-none focus:outline-none focus:ring-2 focus:ring-blue-500">
                                ${teamOptions}
                            </select>
                        </div>
                        <button id="createFranchiseBtn" class="menu-button">Create Franchise</button>
                    </div>
                    <div class="flex flex-col mt-8 space-y-4">
                        <button id="backToHubBtn" class="menu-button bg-gray-700 hover:bg-gray-600">Back</button>
                    </div>
                </div>
            `;
            
            document.getElementById('createFranchiseBtn').addEventListener('click', async () => {
                if (!db || !userId) {
                    showMessageBox("Database not ready. Please try again in a moment.");
                    return;
                }
                const selectedTeam = document.getElementById('franchise-team').value;
                const franchiseDocPath = `artifacts/${__app_id}/users/${userId}/franchise/myFranchise`;
                const franchiseDocRef = firebase.doc(db, franchiseDocPath);
                const newFranchiseData = {
                    teamName: selectedTeam,
                    season: 1,
                    wins: 0,
                    losses: 0,
                    createdAt: new Date().toISOString()
                };
                await firebase.setDoc(franchiseDocRef, newFranchiseData);
                showMessageBox("New franchise created successfully!", () => {
                    currentFranchisePage = 'hub';
                    renderPage();
                });
            });
            document.getElementById('backToHubBtn').addEventListener('click', () => {
                currentFranchisePage = 'hub';
                renderPage();
            });
        };
        
        const renderFranchiseHub = () => {
            const appDiv = document.getElementById('app');
            let contentHTML = '';
            if (!franchiseData) {
                contentHTML = `
                    <div class="space-y-4 text-center">
                        <p>No franchise found. Start a new one to begin your journey!</p>
                        <button id="startNewFranchiseBtn" class="menu-button">Start New Franchise</button>
                    </div>
                `;
            } else {
                contentHTML = `
                    <div class="space-y-4">
                        <p class="text-center">Welcome, <span class="font-bold">${franchiseData.teamName}</span> fan!</p>
                        <p class="text-center text-sm text-gray-400 break-words">User ID: ${userId}</p>
                        <div class="mt-4 p-4 bg-gray-700 rounded-lg">
                            <h2 class="text-lg font-semibold text-center mb-2">Franchise Info</h2>
                            <p>Season: ${franchiseData.season}</p>
                            <p>Record: ${franchiseData.wins} - ${franchiseData.losses}</p>
                        </div>
                        <button id="testCommentaryBtn" class="menu-button mt-4">Test Commentary</button>
                    </div>
                `;
            }
            
            appDiv.innerHTML = `
                <div class="quick-play-card">
                    <h1 class="menu-title">Franchise Hub</h1>
                    ${contentHTML}
                    <div class="flex flex-col mt-8 space-y-4">
                        <button id="backToMainBtn" class="menu-button bg-gray-700 hover:bg-gray-600">Back</button>
                    </div>
                </div>
            `;
            
            if (!franchiseData) {
                document.getElementById('startNewFranchiseBtn').addEventListener('click', () => {
                    currentFranchisePage = 'new-franchise';
                    renderPage();
                });
            } else {
                document.getElementById('testCommentaryBtn').addEventListener('click', () => {
                    const commentary = "First and ten, ball on the twenty-five yard line. The quarterback is in shotgun formation.";
                    playTts(commentary);
                    showMessageBox("Playing commentary... Listen closely!");
                });
            }
            document.getElementById('backToMainBtn').addEventListener('click', () => {
                currentPage = 'main-menu';
                renderPage();
            });
        };

        // Main rendering function to switch between pages
        const renderPage = () => {
            switch (currentPage) {
                case 'main-menu':
                    renderMainMenu();
                    break;
                case 'quick-play':
                    renderQuickPlay();
                    break;
                case 'franchise':
                    if (currentFranchisePage === 'new-franchise') {
                        renderNewFranchise();
                    } else {
                        renderFranchiseHub();
                    }
                    break;
                default:
                    renderMainMenu();
            }
        };

        // --- Initialization and Event Listeners ---
        window.onload = async () => {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                
                const app = firebase.initializeApp(firebaseConfig);
                db = firebase.getFirestore(app);
                auth = firebase.getAuth(app);
                
                await new Promise((resolve, reject) => {
                    const unsubscribe = firebase.onAuthStateChanged(auth, async (user) => {
                        if (user) { userId = user.uid; }
                        else { await firebase.signInAnonymously(auth); }
                        unsubscribe();
                        resolve();
                    });
                    if (initialAuthToken) { firebase.signInWithCustomToken(auth, initialAuthToken).catch(reject); }
                });

                // Set up the real-time listener for franchise data
                const franchiseDocPath = `artifacts/${__app_id}/users/${userId}/franchise/myFranchise`;
                const franchiseDocRef = firebase.doc(db, franchiseDocPath);
                firebase.onSnapshot(franchiseDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        franchiseData = docSnap.data();
                    } else {
                        franchiseData = null;
                    }
                    renderPage(); // Re-render the page whenever data changes
                }, (err) => {
                    console.error("Error fetching franchise data:", err);
                    // You could show a message box here if needed
                });

                renderPage(); // Initial render of the main menu
            } catch (error) {
                console.error("Initialization failed:", error);
                const appDiv = document.getElementById('app');
                appDiv.innerHTML = `<div class="text-red-500 text-center">Failed to load application. Please try again later.</div>`;
            }
        };
    </script>
</body>
</html>