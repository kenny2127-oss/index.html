<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Accessible Pokémon — Map + 300 Pokémon</title>
<link rel="manifest" href="/manifest.json">
<style>
:root {
  --nav: #222;
  --accent: #9be29b;
  --bg: #f7fbff;
  --grass: #78c850;
  --fire: #f08030;
  --water: #6890f0;
  --electric: #f8d030;
  --poison: #a040a0;
  --bug: #a8b820;
  --normal: #a8a878;
  --flying: #a890f0;
  --fairy: #ee99ac;
  --fighting: #c03028;
  --psychic: #f85888;
  --rock: #b8a038;
  --ground: #e0c068;
  --steel: #b8b8d0;
  --dark: #705848;
  --ghost: #705898;
  --ice: #98d8d8;
  --dragon: #7038f8;
}
html, body {
  height: 100%;
  margin: 0;
  font-family: system-ui, Arial, Helvetica, sans-serif;
  background: var(--bg);
  color: #111;
  display: flex;
  flex-direction: column;
}
main {
  flex: 1;
  overflow: auto;
  padding: 12px 12px 92px;
}
nav {
  display: flex;
  gap: 0;
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--nav);
  color: #fff;
  z-index: 10;
}
nav button {
  flex: 1;
  padding: 12px 8px;
  border: 0;
  background: transparent;
  color: #fff;
  font-size: 15px;
  cursor: pointer;
}
nav button.active {
  background: #111;
  outline: 3px solid #ff0;
}
nav button:focus {
  outline: 2px solid var(--accent);
}
h1 {
  margin: 8px 0 6px;
}
.panel {
  background: #fff;
  border: 1px solid #e3e7ef;
  border-radius: 10px;
  padding: 10px;
}
.flex {
  display: flex;
  gap: 8px;
  align-items: center;
  flex-wrap: wrap;
}
.btn {
  padding: 9px 12px;
  border: 0;
  border-radius: 9px;
  background: #1976d2;
  color: #fff;
  cursor: pointer;
}
.btn.alt {
  background: var(--accent);
  color: #000;
}
.btn.ghost {
  background: transparent;
  border: 1px solid #cfd6e4;
  color: #000;
}
select, input, button {
  font-size: 15px;
}
label {
  display: block;
  margin: 6px 0 2px;
}
small, .sub {
  color: #555;
}
.kv {
  display: flex;
  justify-content: space-between;
  border-bottom: 1px dashed #eee;
  padding: 6px 0;
}
.grid {
  display: grid;
  gap: 8px;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
}
.tab {
  display: none;
}
.tab.active {
  display: block;
}
.battle-subtab {
  display: none;
}
.battle-subtab.active {
  display: block;
}
.pokemon {
  padding: 8px;
  border-radius: 6px;
}
@media (min-width: 720px) {
  main {
    padding: 18px 18px 116px;
  }
  nav button {
    font-size: 16px;
  }
}
</style>
</head>
<body>
<main>
  <!-- HOME -->
  <section id="home" class="tab active" role="tabpanel" aria-labelledby="home-tab">
    <h1>Home</h1>
    <div id="player-info" class="panel" aria-live="polite"></div>
    <div class="flex">
      <button id="open-pokedex" class="btn alt">Open Pokedex</button>
      <button id="save-manual" class="btn ghost">Save Now</button>
      <button id="reset-game" class="btn ghost">Reset Save</button>
    </div>
    <div class="panel">
      <h2>Bank</h2>
      <div class="flex">
        <div>
          <label for="bank-deposit-amount">Deposit</label>
          <select id="bank-deposit-amount">
            <option value="">Choose</option>
            <option value="10">$10</option>
            <option value="20">$20</option>
            <option value="50">$50</option>
            <option value="all">All</option>
          </select>
        </div>
        <div>
          <label for="bank-withdraw-amount">Withdraw</label>
          <select id="bank-withdraw-amount">
            <option value="">Choose</option>
            <option value="10">$10</option>
            <option value="20">$20</option>
            <option value="50">$50</option>
            <option value="all">All</option>
          </select>
        </div>
      </div>
    </div>
    <div class="panel" id="party-panel">
      <h2>Party</h2>
      <div id="party-list" class="grid" aria-live="polite"></div>
      <h3>Box</h3>
      <div id="box-list" class="grid" aria-live="polite"></div>
    </div>
    <h2>Pokedex</h2>
    <div id="pokedex-list" class="panel" style="display:none" aria-live="polite"></div>
  </section>

  <!-- MAP -->
  <section id="map" class="tab" role="tabpanel" aria-labelledby="map-tab">
    <h1>Map</h1>
    <div class="panel">
      <p class="sub">Travel to different locations. Explore and Gather will be affected by your current location.</p>
      <div id="locations-list" class="grid"></div>
      <div id="location-features" style="margin-top:10px;"></div>
      <p id="map-log" aria-live="polite"></p>
    </div>
  </section>

  <!-- INVENTORY -->
  <section id="inventory" class="tab" role="tabpanel" aria-labelledby="inventory-tab">
    <h1>Inventory</h1>
    <div id="inventory-list" class="panel" aria-live="polite"></div>
  </section>

  <!-- EXPLORE -->
  <section id="explore" class="tab" role="tabpanel" aria-labelledby="explore-tab">
    <h1>Explore</h1>
    <div class="panel">
      <p class="sub">Find wild Pokémon. Encounter chances depend on your current location.</p>
      <button id="catch-pokemon" class="btn alt">Search & Catch</button>
      <p id="explore-log" aria-live="polite"></p>
    </div>
  </section>

  <!-- GATHER -->
  <section id="gather" class="tab" role="tabpanel" aria-labelledby="gather-tab">
    <h1>Gather</h1>
    <div class="panel">
      <p class="sub">Gather resources from your current location.</p>
      <button id="gather-resource" class="btn alt">Gather Resource (+10 XP)</button>
      <p id="gather-log" aria-live="polite"></p>
    </div>
  </section>

  <!-- BATTLE -->
  <section id="battle" class="tab" role="tabpanel" aria-labelledby="battle-tab">
    <h1>Battle</h1>
    <div class="flex">
      <button id="battle-wild-tab" class="btn alt active" data-target="battle-wild">Wild Battle</button>
      <button id="battle-gym-tab" class="btn" data-target="battle-gym">Gym Battle</button>
    </div>
    <div id="battle-wild" class="battle-subtab active">
      <div class="flex" style="margin-top:10px;">
        <button id="start-battle" class="btn alt">Start Wild Battle</button>
        <button id="challenge-gym" class="btn">Challenge Gym</button>
      </div>
    </div>
    <div id="battle-gym" class="battle-subtab">
      <div class="flex" style="margin-top:10px;">
        <button id="start-gym-battle" class="btn alt">Start Gym Battle</button>
      </div>
    </div>
    <div id="battle-area" style="margin-top:12px;display:none;">
      <div class="panel" id="battle-stats" aria-live="polite"></div>
      <label for="battle-pokemon">Select Pokémon:</label>
      <select id="battle-pokemon"></select>
      <div id="move-buttons" class="flex" style="margin-top:10px;"></div>
    </div>
    <p id="battle-log" aria-live="assertive" style="white-space:pre-wrap;margin-top:10px;"></p>
  </section>

  <!-- TRADE -->
  <section id="trade" class="tab" role="tabpanel" aria-labelledby="trade-tab">
    <h1>Trade</h1>
    <div class="flex">
      <button id="sell-all-top" class="btn alt">Sell All Sellable Items</button>
    </div>
    <label for="trade-mode">Choose Mode</label>
    <select id="trade-mode">
      <option value="buy">Buy Items</option>
      <option value="sell">Sell Items</option>
    </select>
    <div id="trade-panel" class="panel" style="margin-top:10px" aria-live="polite"></div>
  </section>
</main>

<nav role="tablist">
  <button id="home-tab" class="tab-btn active" data-target="home" role="tab" aria-controls="home" aria-selected="true">Home</button>
  <button id="map-tab" class="tab-btn" data-target="map" role="tab" aria-controls="map" aria-selected="false">Map</button>
  <button id="inventory-tab" class="tab-btn" data-target="inventory" role="tab" aria-controls="inventory" aria-selected="false">Inventory</button>
  <button id="explore-tab" class="tab-btn" data-target="explore" role="tab" aria-controls="explore" aria-selected="false">Explore</button>
  <button id="gather-tab" class="tab-btn" data-target="gather" role="tab" aria-controls="gather" aria-selected="false">Gather</button>
  <button id="battle-tab" class="tab-btn" data-target="battle" role="tab" aria-controls="battle" aria-selected="false">Battle</button>
  <button id="trade-tab" class="tab-btn" data-target="trade" role="tab" aria-controls="trade" aria-selected="false">Trade</button>
</nav>

<script>
// ===== UTILS =====
const rng = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
const beep = (freq = 660, dur = 120) => {
  if (!window.AudioContext && !window.webkitAudioContext) return;
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = 'sine';
    o.frequency.setValueAtTime(freq, ctx.currentTime);
    g.gain.setValueAtTime(0.18, ctx.currentTime);
    o.connect(g);
    g.connect(ctx.destination);
    o.start();
    setTimeout(() => {
      o.stop();
      ctx.close();
    }, dur);
  } catch (e) {
    console.error('AudioContext error:', e);
  }
};

// ===== DATA =====
const pokemonData = [
  {"id": 1, "name": "Bulbasaur", "type1": "Grass", "type2": "Poison"},
  {"id": 2, "name": "Ivysaur", "type1": "Grass", "type2": "Poison"},
  {"id": 3, "name": "Venusaur", "type1": "Grass", "type2": "Poison"},
  {"id": 4, "name": "Charmander", "type1": "Fire", "type2": null},
  {"id": 5, "name": "Charmeleon", "type1": "Fire", "type2": null},
  {"id": 6, "name": "Charizard", "type1": "Fire", "type2": "Flying"},
  {"id": 7, "name": "Squirtle", "type1": "Water", "type2": null},
  {"id": 8, "name": "Wartortle", "type1": "Water", "type2": null},
  {"id": 9, "name": "Blastoise", "type1": "Water", "type2": null},
  {"id": 10, "name": "Caterpie", "type1": "Bug", "type2": null},
  {"id": 11, "name": "Metapod", "type1": "Bug", "type2": null},
  {"id": 12, "name": "Butterfree", "type1": "Bug", "type2": "Flying"},
  {"id": 13, "name": "Weedle", "type1": "Bug", "type2": "Poison"},
  {"id": 14, "name": "Kakuna", "type1": "Bug", "type2": "Poison"},
  {"id": 15, "name": "Beedrill", "type1": "Bug", "type2": "Poison"},
  {"id": 16, "name": "Pidgey", "type1": "Normal", "type2": "Flying"},
  {"id": 17, "name": "Pidgeotto", "type1": "Normal", "type2": "Flying"},
  {"id": 18, "name": "Pidgeot", "type1": "Normal", "type2": "Flying"},
  {"id": 19, "name": "Rattata", "type1": "Normal", "type2": null},
  {"id": 20, "name": "Raticate", "type1": "Normal", "type2": null},
  {"id": 21, "name": "Spearow", "type1": "Normal", "type2": "Flying"},
  {"id": 22, "name": "Fearow", "type1": "Normal", "type2": "Flying"},
  {"id": 23, "name": "Ekans", "type1": "Poison", "type2": null},
  {"id": 24, "name": "Arbok", "type1": "Poison", "type2": null},
  {"id": 25, "name": "Pikachu", "type1": "Electric", "type2": null},
  {"id": 26, "name": "Raichu", "type1": "Electric", "type2": null},
  {"id": 27, "name": "Sandshrew", "type1": "Ground", "type2": null},
  {"id": 28, "name": "Sandslash", "type1": "Ground", "type2": null},
  {"id": 29, "name": "Nidoran♀", "type1": "Poison", "type2": null},
  {"id": 30, "name": "Nidorina", "type1": "Poison", "type2": null},
  {"id": 31, "name": "Nidoqueen", "type1": "Poison", "type2": "Ground"},
  {"id": 32, "name": "Nidoran♂", "type1": "Poison", "type2": null},
  {"id": 33, "name": "Nidorino", "type1": "Poison", "type2": null},
  {"id": 34, "name": "Nidoking", "type1": "Poison", "type2": "Ground"},
  {"id": 35, "name": "Clefairy", "type1": "Fairy", "type2": null},
  {"id": 36, "name": "Clefable", "type1": "Fairy", "type2": null},
  {"id": 37, "name": "Vulpix", "type1": "Fire", "type2": null},
  {"id": 38, "name": "Ninetales", "type1": "Fire", "type2": null},
  {"id": 151, "name": "Mew", "type1": "Psychic", "type2": null},
  {"id": 152, "name": "Chikorita", "type1": "Grass", "type2": null},
  {"id": 300, "name": "Placeholder300", "type1": "Normal", "type2": null}
];

const typeToLocation = {
  'Grass': 'Forest',
  'Poison': 'Forest',
  'Bug': 'Forest',
  'Normal': 'Forest',
  'Flying': 'Forest',
  'Fairy': 'Forest',
  'Fire': 'Mountain',
  'Fighting': 'Mountain',
  'Dragon': 'Mountain',
  'Rock': 'Cave',
  'Ground': 'Cave',
  'Steel': 'Cave',
  'Dark': 'Cave',
  'Ghost': 'Cave',
  'Psychic': 'Cave',
  'Water': 'Beach',
  'Ice': 'Beach',
  'Electric': 'City'
};

const locations = [
  {name: 'Forest', resources: ['Berry', 'Herb']},
  {name: 'Cave', resources: ['Stone', 'Ore']},
  {name: 'Beach', resources: ['Shell', 'Sand']},
  {name: 'Mountain', resources: ['Gem', 'Rock']},
  {name: 'City', resources: ['Potion', 'Ball']},
];

locations.forEach(loc => {
  loc.encounters = pokemonData.filter(p => {
    const types = [p.type1, p.type2].filter(t => t);
    return types.some(t => typeToLocation[t] === loc.name);
  }).map(p => p.id).filter(id => id <= 300);
});

const itemsData = [
  {name: 'Potion', price: 300, sell: 150},
  {name: 'Poke Ball', price: 200, sell: 100},
  {name: 'Berry', price: 20, sell: 10},
  {name: 'Stone', price: 100, sell: 50},
  {name: 'Gem', price: 500, sell: 250},
  {name: 'Herb', price: 50, sell: 25},
  {name: 'Ore', price: 80, sell: 40},
  {name: 'Shell', price: 60, sell: 30},
  {name: 'Sand', price: 10, sell: 5},
  {name: 'Rock', price: 40, sell: 20},
  {name: 'Ball', price: 150, sell: 75},
];

const typeResource = {
  'Grass': 'Herb',
  'Fire': 'Ore',
  'Water': 'Shell',
  'Bug': 'Berry',
  'Normal': 'Potion',
  'Poison': 'Herb',
  'Electric': 'Potion',
  'Ground': 'Stone',
  'Fairy': 'Gem',
  'Fighting': 'Rock',
  'Psychic': 'Gem',
  'Rock': 'Stone',
  'Ghost': 'Gem',
  'Ice': 'Shell',
  'Dragon': 'Gem',
  'Dark': 'Ore',
  'Steel': 'Ore',
  'Flying': 'Berry'
};

const moves = [
  {name: 'Tackle', type: 'Normal', power: 40},
  {name: 'Scratch', type: 'Normal', power: 40},
  {name: 'Vine Whip', type: 'Grass', power: 45},
  {name: 'Ember', type: 'Fire', power: 40},
  {name: 'Water Gun', type: 'Water', power: 40},
  {name: 'Thunder Shock', type: 'Electric', power: 40},
];

const typeEffectiveness = {
  Fire: {Water: 0.5, Grass: 2, Ice: 2, Bug: 2, Steel: 2},
  Water: {Fire: 2, Ground: 2, Rock: 2},
  Grass: {Water: 2, Ground: 2, Rock: 2, Fire: 0.5, Bug: 0.5},
  Electric: {Water: 2, Flying: 2, Ground: 0},
  Psychic: {Fighting: 2, Poison: 2, Dark: 0},
  Ice: {Grass: 2, Ground: 2, Flying: 2, Dragon: 2, Fire: 0.5, Water: 0.5, Ice: 0.5, Steel: 0.5},
  Dragon: {Dragon: 2, Fairy: 0},
  Dark: {Psychic: 2, Ghost: 2, Fighting: 0.5, Dark: 0.5, Fairy: 0.5},
  Fairy: {Dragon: 2, Fighting: 2, Dark: 2, Poison: 0.5, Steel: 0.5},
  Normal: {},
  Fighting: {Normal: 2, Ice: 2, Rock: 2, Dark: 2, Steel: 2, Flying: 0.5, Psychic: 0.5, Bug: 0.5, Fairy: 0.5, Ghost: 0},
  Flying: {Grass: 2, Fighting: 2, Bug: 2, Electric: 0.5, Rock: 0.5, Steel: 0.5},
  Poison: {Grass: 2, Fairy: 2, Poison: 0.5, Ground: 0.5, Rock: 0.5, Ghost: 0.5, Steel: 0},
  Ground: {Fire: 2, Electric: 2, Poison: 2, Rock: 2, Steel: 2, Grass: 0.5, Bug: 0.5, Flying: 0},
  Rock: {Fire: 2, Ice: 2, Flying: 2, Bug: 2, Fighting: 0.5, Ground: 0.5, Steel: 0.5},
  Bug: {Grass: 2, Psychic: 2, Dark: 2, Fire: 0.5, Fighting: 0.5, Poison: 0.5, Flying: 0.5, Ghost: 0.5, Steel: 0.5, Fairy: 0.5},
  Ghost: {Psychic: 2, Ghost: 2, Dark: 0.5, Normal: 0},
  Steel: {Ice: 2, Rock: 2, Fairy: 2, Fire: 0.5, Water: 0.5, Electric: 0.5},
};

// ===== SAVE / PLAYER =====
const DEFAULT_PLAYER = {
  level: 1,
  xp: 0,
  money: 1000,
  bank: 0,
  inventory: {},
  party: [],
  box: [],
  seen: new Set(),
  badges: 0,
  location: 'Forest',
};
let player = loadPlayer();

function loadPlayer() {
  try {
    const saved = localStorage.getItem('pkm_player_v11');
    if (saved) return JSON.parse(saved);
  } catch (e) {
    console.error('Failed to load player data:', e);
  }
  localStorage.setItem('pkm_player_v11', JSON.stringify(DEFAULT_PLAYER));
  return structuredClone(DEFAULT_PLAYER);
}

function savePlayer() {
  try {
    localStorage.setItem('pkm_player_v11', JSON.stringify(player));
    updateUI();
  } catch (e) {
    console.error('Failed to save player data:', e);
  }
}

function resetPlayer() {
  if (confirm('Reset save?')) {
    player = structuredClone(DEFAULT_PLAYER);
    savePlayer();
    location.reload();
  }
}

function gainXP(amount) {
  player.xp += amount;
  while (player.xp >= 100) {
    player.level++;
    player.xp -= 100;
    beep(880, 140);
    alert(`Leveled up! Level ${player.level}`);
  }
  savePlayer();
}

// ===== UI UPDATES =====
function updateUI() {
  // Player Info
  const playerInfo = document.getElementById('player-info');
  playerInfo.innerHTML = `
    <div class="kv"><span>Level</span><span>${player.level}</span></div>
    <div class="kv"><span>XP</span><span>${player.xp}/100</span></div>
    <div class="kv"><span>Money</span><span>$${player.money}</span></div>
    <div class="kv"><span>Bank</span><span>$${player.bank}</span></div>
    <div class="kv"><span>Location</span><span>${player.location}</span></div>
    <div class="kv"><span>Badges</span><span>${player.badges}</span></div>
  `;

  // Party and Box
  const partyList = document.getElementById('party-list');
  partyList.innerHTML = player.party.length ? player.party.map((p, i) => `
    <div tabindex="0" aria-label="${p.name}, ${p.type1}${p.type2 ? '/' + p.type2 : ''}, level ${p.level}, HP ${p.hp}/${p.maxHp}" class="pokemon" style="background: var(--${typeStyles[p.type1.toLowerCase()] || 'normal'});">
      ${p.name} (${p.type1}${p.type2 ? '/' + p.type2 : ''})<br>
      Lv ${p.level}, HP: ${p.hp}/${p.maxHp}<br>
      <button onclick="moveToBox(${i})">Move to Box</button>
    </div>`).join('') : '<p>No Pokémon in party</p>';
  const boxList = document.getElementById('box-list');
  boxList.innerHTML = player.box.length ? player.box.map((p, i) => `
    <div tabindex="0" aria-label="${p.name}, ${p.type1}${p.type2 ? '/' + p.type2 : ''}, level ${p.level}, HP ${p.hp}/${p.maxHp}" class="pokemon" style="background: var(--${typeStyles[p.type1.toLowerCase()] || 'normal'});">
      ${p.name} (${p.type1}${p.type2 ? '/' + p.type2 : ''})<br>
      Lv ${p.level}, HP: ${p.hp}/${p.maxHp}
    </div>`).join('') : '<p>No Pokémon in box</p>';

  // Inventory
  const inventoryList = document.getElementById('inventory-list');
  inventoryList.innerHTML = Object.keys(player.inventory).length ? Object.entries(player.inventory).map(([item, qty]) => `<div class="kv"><span>${item}</span><span>${qty}</span></div>`).join('') : '<p>Inventory empty</p>';

  // Locations
  const locationsList = document.getElementById('locations-list');
  locationsList.innerHTML = locations.map(loc => `
    <button class="btn ${player.location === loc.name ? 'alt' : ''}" onclick="changeLocation('${loc.name}')">${loc.name}</button>
  `).join('');

  // Location features for City
  const features = document.getElementById('location-features');
  features.innerHTML = '';
  if (player.location === 'City') {
    features.innerHTML = `
      <select id="city-action">
        <option value="">Choose Action</option>
        <option value="market">Pokémon Market</option>
        <option value="poke-center">Poké Center</option>
      </select>
      <div id="market-panel" style="display:none">
        <label for="market-mode">Choose Mode</label>
        <select id="market-mode">
          <option value="buy">Purchase Items</option>
          <option value="sell">Sell Items</option>
        </select>
        <div id="market-content" class="panel" style="margin-top:10px" aria-live="polite"></div>
        <p id="market-log" aria-live="polite"></p>
      </div>
      <div id="poke-center-panel" style="display:none">
        <h3>Poké Center</h3>
        <div class="flex">
          <button onclick="healPokemon()">Heal All Pokémon ($50)</button>
          <button onclick="updatePokeCenter()">Show Upgrade Options</button>
        </div>
        <div id="upgrade-list" class="grid" style="margin-top:10px" aria-live="polite"></div>
      </div>
    `;
    const cityAction = document.getElementById('city-action');
    cityAction.addEventListener('change', handleCityActionChange);
    const marketMode = document.getElementById('market-mode');
    marketMode.addEventListener('change', updateMarket);
  }

  // Trade Panel
  const tradePanel = document.getElementById('trade-panel');
  if (tradePanel) {
    const tradeMode = document.getElementById('trade-mode').value;
    if (tradeMode === 'buy') {
      tradePanel.innerHTML = itemsData.map(item => `<div class="kv"><span>${item.name} ($${item.price})</span><button onclick="buyItem('${item.name}', ${item.price})">Buy</button></div>`).join('');
    } else {
      tradePanel.innerHTML = Object.entries(player.inventory).map(([item, qty]) => {
        const price = itemsData.find(i => i.name === item)?.sell || 0;
        return `<div class="kv"><span>${item} x${qty} ($${price} each)</span><button onclick="sellItem('${item}', ${price})">Sell All</button></div>`;
      }).join('');
    }
  }

  // Pokedex
  const pokedexList = document.getElementById('pokedex-list');
  if (pokedexList.style.display !== 'none') {
    pokedexList.innerHTML = pokemonData.filter(p => player.seen.has(p.id)).map(p => `<div>${p.id}. ${p.name} (${p.type1}${p.type2 ? '/' + p.type2 : ''})</div>`).join('') || '<p>No Pokémon seen yet</p>';
  }

  // Poké Center Upgrade List
  const upgradeList = document.getElementById('upgrade-list');
  if (upgradeList && document.getElementById('poke-center-panel')?.style.display === 'block') {
    updatePokeCenter();
  }

  // Battle Pokémon Selector
  const battlePokemonSelect = document.getElementById('battle-pokemon');
  if (battlePokemonSelect && document.getElementById('battle-area').style.display === 'block') {
    battlePokemonSelect.innerHTML = player.party.map((p, i) => `
      <option value="${i}" ${battleState.playerMon === p ? 'selected' : ''}>
        ${p.name} (${p.type1}${p.type2 ? '/' + p.type2 : ''}, Lv ${p.level}, HP ${p.hp}/${p.maxHp})
      </option>
    `).join('');
  }
}

// ===== TAB NAVIGATION =====
function setupTabs() {
  const tabs = document.querySelectorAll('.tab-btn');
  tabs.forEach(tab => {
    tab.removeEventListener('click', handleTabClick);
    tab.removeEventListener('keydown', handleTabKeydown);
    tab.addEventListener('click', handleTabClick);
    tab.addEventListener('keydown', handleTabKeydown);
  });

  // Battle Subtabs
  const battleTabs = document.querySelectorAll('#battle .btn[data-target]');
  battleTabs.forEach(tab => {
    tab.removeEventListener('click', handleBattleTabClick);
    tab.removeEventListener('keydown', handleBattleTabKeydown);
    tab.addEventListener('click', handleBattleTabClick);
    tab.addEventListener('keydown', handleBattleTabKeydown);
  });
}

function handleTabClick(e) {
  const tab = e.currentTarget;
  const tabs = document.querySelectorAll('.tab-btn');
  tabs.forEach(t => {
    t.classList.remove('active');
    t.setAttribute('aria-selected', 'false');
  });
  tab.classList.add('active');
  tab.setAttribute('aria-selected', 'true');

  document.querySelectorAll('.tab').forEach(panel => {
    panel.classList.remove('active');
  });
  const targetPanel = document.getElementById(tab.dataset.target);
  if (targetPanel) {
    targetPanel.classList.add('active');
  } else {
    console.error(`Target panel ${tab.dataset.target} not found`);
  }
  updateUI();
}

function handleTabKeydown(e) {
  if (e.key === 'Enter' || e.key === ' ') {
    e.preventDefault();
    handleTabClick(e);
  }
}

function handleBattleTabClick(e) {
  const tab = e.currentTarget;
  const battleTabs = document.querySelectorAll('#battle .btn[data-target]');
  battleTabs.forEach(t => t.classList.remove('active'));
  tab.classList.add('active');

  document.querySelectorAll('.battle-subtab').forEach(panel => {
    panel.classList.remove('active');
  });
  const targetPanel = document.getElementById(tab.dataset.target);
  if (targetPanel) {
    targetPanel.classList.add('active');
  } else {
    console.error(`Target battle subtab ${tab.dataset.target} not found`);
  }
}

function handleBattleTabKeydown(e) {
  if (e.key === 'Enter' || e.key === ' ') {
    e.preventDefault();
    handleBattleTabClick(e);
  }
}

// ===== GAME LOGIC =====
function changeLocation(location) {
  player.location = location;
  document.getElementById('map-log').textContent = `Moved to ${location}!`;
  updateUI();
  savePlayer();
}

function depositMoney(amount) {
  if (amount === 'all') amount = player.money;
  amount = parseInt(amount);
  if (isNaN(amount) || amount > player.money || amount <= 0) {
    alert('Invalid deposit amount!');
    return;
  }
  player.money -= amount;
  player.bank += amount;
  savePlayer();
}

function withdrawMoney(amount) {
  if (amount === 'all') amount = player.bank;
  amount = parseInt(amount);
  if (isNaN(amount) || amount > player.bank || amount <= 0) {
    alert('Invalid withdrawal amount!');
    return;
  }
  player.bank -= amount;
  player.money += amount;
  savePlayer();
}

function catchPokemon() {
  const loc = locations.find(l => l.name === player.location);
  if (!loc || loc.encounters.length === 0) {
    document.getElementById('explore-log').textContent = 'No Pokémon found in this location!';
    return;
  }
  const id = loc.encounters[rng(0, loc.encounters.length - 1)];
  const base = pokemonData.find(p => p.id === id);
  if (!base) {
    document.getElementById('explore-log').textContent = 'Error finding Pokémon!';
    return;
  }
  const caught = { ...base, level: rng(1, player.level + 5), hp: 50, maxHp: 50, moves: [moves[rng(0, moves.length - 1)], moves[rng(0, moves.length - 1)] ] };
  player.seen.add(id);
  player.party.push(caught); // Add to party regardless of size
  document.getElementById('explore-log').textContent = `Caught ${caught.name} (Lv ${caught.level})! Added to party.`;
  beep(660, 120);
  savePlayer();
}

function moveToBox(index) {
  const mon = player.party.splice(index, 1)[0];
  player.box.push(mon);
  savePlayer();
  alert(`${mon.name} moved to box!`);
}

function gatherResource() {
  const loc = locations.find(l => l.name === player.location);
  if (!loc) return;
  const resource = loc.resources[rng(0, loc.resources.length - 1)];
  player.inventory[resource] = (player.inventory[resource] || 0) + 1;
  gainXP(10);
  document.getElementById('gather-log').textContent = `Gathered 1 ${resource}!`;
  beep(660, 120);
  savePlayer();
}

function togglePokedex() {
  const pokedex = document.getElementById('pokedex-list');
  pokedex.style.display = pokedex.style.display === 'none' ? 'block' : 'none';
  updateUI();
}

let battleState = {};

function startBattle(isGym = false) {
  if (player.party.length === 0) {
    alert('No Pokémon in party!');
    return;
  }
  battleState.playerMon = player.party[0];
  const level = isGym ? player.level + 10 : rng(1, player.level + 5);
  const id = rng(1, pokemonData.length);
  const base = pokemonData.find(p => p.id === id);
  battleState.opponent = { ...base, level, hp: 50 + level * 5, maxHp: 50 + level * 5, moves: [moves[rng(0, moves.length - 1)], moves[rng(0, moves.length - 1)] ], isGym };
  const battleArea = document.getElementById('battle-area');
  battleArea.style.display = 'block';
  updateBattleUI();
  document.getElementById('battle-log').textContent = `A wild ${battleState.opponent.name} (Lv ${battleState.opponent.level}) appeared!\nYour ${battleState.playerMon.name} (Lv ${battleState.playerMon.level}) is fighting.`;
  beep(440, 200);
}

function startGymBattle() {
  if (player.party.length === 0) {
    alert('No Pokémon in party!');
    return;
  }
  battleState.playerMon = player.party[0];
  const level = player.level + 10;
  const id = rng(1, pokemonData.length);
  const base = pokemonData.find(p => p.id === id);
  battleState.opponent = { ...base, level, hp: 50 + level * 5, maxHp: 50 + level * 5, moves: [moves[rng(0, moves.length - 1)], moves[rng(0, moves.length - 1)] ], isGym: true };
  const battleArea = document.getElementById('battle-area');
  battleArea.style.display = 'block';
  updateBattleUI();
  document.getElementById('battle-log').textContent = `Gym Leader sent out ${battleState.opponent.name} (Lv ${battleState.opponent.level})!\nYour ${battleState.playerMon.name} (Lv ${battleState.playerMon.level}) is fighting.`;
  beep(440, 200);
}

function challengeGym() {
  if (player.badges >= 8) {
    alert('You have all badges!');
    return;
  }
  startGymBattle();
}

function updateBattleUI() {
  const battleStats = document.getElementById('battle-stats');
  battleStats.innerHTML = `
    <div class="kv"><span>Opponent: ${battleState.opponent.name} (${battleState.opponent.type1}${battleState.opponent.type2 ? '/' + battleState.opponent.type2 : ''}, Lv ${battleState.opponent.level})</span><span>HP: ${battleState.opponent.hp}/${battleState.opponent.maxHp}</span></div>
    <div class="kv"><span>Your: ${battleState.playerMon.name} (${battleState.playerMon.type1}${battleState.playerMon.type2 ? '/' + battleState.playerMon.type2 : ''}, Lv ${battleState.playerMon.level})</span><span>HP: ${battleState.playerMon.hp}/${battleState.playerMon.maxHp}</span></div>
  `;
  const moveButtons = document.getElementById('move-buttons');
  moveButtons.innerHTML = battleState.playerMon.moves.map((move, i) => `<button onclick="playerAttack(${i})">${move.name} (${move.type}, Power: ${move.power})</button>`).join('');
  const battlePokemonSelect = document.getElementById('battle-pokemon');
  battlePokemonSelect.innerHTML = player.party.map((p, i) => `
    <option value="${i}" ${battleState.playerMon === p ? 'selected' : ''}>
      ${p.name} (${p.type1}${p.type2 ? '/' + p.type2 : ''}, Lv ${p.level}, HP ${p.hp}/${p.maxHp})
    </option>
  `).join('');
  battlePokemonSelect.addEventListener('change', (e) => {
    battleState.playerMon = player.party[parseInt(e.target.value)];
    updateBattleUI();
  });
}

function playerAttack(moveIndex) {
  const move = battleState.playerMon.moves[moveIndex];
  const multiplier = getTypeMultiplier(move.type, battleState.opponent.type1) * (battleState.opponent.type2 ? getTypeMultiplier(move.type, battleState.opponent.type2) : 1);
  const damage = Math.max(1, Math.floor(move.power * multiplier * (battleState.playerMon.level / battleState.opponent.level)));
  battleState.opponent.hp -= damage;
  document.getElementById('battle-log').textContent += `\n${battleState.playerMon.name} used ${move.name}! Dealt ${damage} damage.`;
  if (battleState.opponent.hp <= 0) {
    endBattle(true);
    return;
  }
  opponentAttack();
}

function opponentAttack() {
  const move = battleState.opponent.moves[rng(0, battleState.opponent.moves.length - 1)];
  const multiplier = getTypeMultiplier(move.type, battleState.playerMon.type1) * (battleState.playerMon.type2 ? getTypeMultiplier(move.type, battleState.playerMon.type2) : 1);
  const damage = Math.max(1, Math.floor(move.power * multiplier * (battleState.opponent.level / battleState.playerMon.level)));
  battleState.playerMon.hp -= damage;
  document.getElementById('battle-log').textContent += `\nOpponent used ${move.name}! Dealt ${damage} damage.`;
  if (battleState.playerMon.hp <= 0) {
    endBattle(false);
    return;
  }
  updateBattleUI();
}

function endBattle(won) {
  const battleArea = document.getElementById('battle-area');
  battleArea.style.display = 'none';
  if (won) {
    const isGym = battleState.opponent.isGym;
    const xpGain = isGym ? 150 : 50;
    const moneyGain = isGym ? 500 : 100;
    gainXP(xpGain);
    player.money += moneyGain;
    if (isGym) {
      player.badges++;
      alert(`You won the gym battle! Earned a badge, $${moneyGain}, and ${xpGain} XP.`);
    } else {
      alert(`You won the battle! Earned $${moneyGain} and ${xpGain} XP.`);
    }
    beep(880, 140);
  } else {
    alert('You lost the battle.');
    beep(220, 200);
  }
  savePlayer();
}

function getTypeMultiplier(attackType, defType) {
  return typeEffectiveness[attackType]?.[defType] || 1;
}

function buyItem(item, price) {
  if (player.money < price) {
    alert('Not enough money!');
    return;
  }
  player.money -= price;
  player.inventory[item] = (player.inventory[item] || 0) + 1;
  const marketLog = document.getElementById('market-log');
  if (marketLog) {
    marketLog.textContent = `Bought 1 ${item}!`;
  }
  updateMarket(); // Refresh only market content
  savePlayer();
}

function sellItem(item, price) {
  const qty = player.inventory[item] || 0;
  if (qty <= 0) {
    alert('No item to sell!');
    return;
  }
  const total = qty * price;
  player.inventory[item] = 0;
  delete player.inventory[item];
  player.money += total;
  const marketLog = document.getElementById('market-log');
  if (marketLog) {
    marketLog.textContent = `Sold all ${item} for $${total}!`;
  }
  updateMarket(); // Refresh only market content without full UI update
  beep(660, 120);
  savePlayer();
}

function sellAll() {
  let total = 0;
  for (const [item, qty] of Object.entries(player.inventory)) {
    const price = itemsData.find(i => i.name === item)?.sell || 0;
    total += qty * price;
    delete player.inventory[item];
  }
  player.money += total;
  const tradePanel = document.getElementById('trade-panel');
  if (tradePanel) {
    tradePanel.textContent = `Sold all items for $${total}!`;
  }
  savePlayer();
}

function handleCityActionChange() {
  const cityAction = document.getElementById('city-action');
  const marketPanel = document.getElementById('market-panel');
  const pokeCenterPanel = document.getElementById('poke-center-panel');
  marketPanel.style.display = 'none';
  pokeCenterPanel.style.display = 'none';
  if (cityAction.value === 'market') {
    marketPanel.style.display = 'block';
    updateMarket();
  } else if (cityAction.value === 'poke-center') {
    pokeCenterPanel.style.display = 'block';
    updatePokeCenter();
  }
}

function updateMarket() {
  const mode = document.getElementById('market-mode').value;
  const content = document.getElementById('market-content');
  const marketLog = document.getElementById('market-log');
  marketLog.textContent = '';
  if (mode === 'buy') {
    content.innerHTML = itemsData.map(item => `<div class="kv"><span>${item.name} ($${item.price})</span><button onclick="buyItem('${item.name}', ${item.price})">Buy</button></div>`).join('');
  } else {
    content.innerHTML = Object.entries(player.inventory).map(([item, qty]) => {
      const price = itemsData.find(i => i.name === item)?.sell || 0;
      return `<div class="kv"><span>${item} x${qty} ($${price} each)</span><button onclick="sellItem('${item}', ${price})">Sell All</button></div>`;
    }).join('');
  }
}

function healPokemon() {
  if (player.money < 50) {
    alert('Not enough money to heal ($50 required)!');
    return;
  }
  player.money -= 50;
  player.party.forEach(p => {
    p.hp = p.maxHp;
  });
  player.box.forEach(p => {
    p.hp = p.maxHp;
  });
  alert('All Pokémon healed!');
  beep(880, 140);
  savePlayer();
}

function updatePokeCenter() {
  const upgradeList = document.getElementById('upgrade-list');
  if (upgradeList) {
    upgradeList.innerHTML = [...player.party, ...player.box].map((mon, globalIndex) => {
      const resource = typeResource[mon.type1] || 'Potion';
      const locs = locations.filter(l => l.resources.includes(resource)).map(l => l.name).join(', ') || 'Not available';
      const isParty = globalIndex < player.party.length;
      const index = isParty ? globalIndex : globalIndex - player.party.length;
      return `<div class="pokemon" style="background: var(--${typeStyles[mon.type1.toLowerCase()] || 'normal'});">
        ${mon.name} (${mon.type1}${mon.type2 ? '/' + mon.type2 : ''}, Lv ${mon.level})<br>
        Requires: ${resource} x1 (found in ${locs})<br>
        <button onclick="upgradePokemon('${isParty ? 'party' : 'box'}', ${index})">Upgrade</button>
      </div>`;
    }).join('') || '<p>No Pokémon to upgrade.</p>';
  }
}

function upgradePokemon(storageType, index) {
  const mon = storageType === 'party' ? player.party[index] : player.box[index];
  const resource = typeResource[mon.type1] || 'Potion';
  if ((player.inventory[resource] || 0) < 1) {
    alert(`Need 1 ${resource} to upgrade!`);
    return;
  }
  player.inventory[resource]--;
  if (player.inventory[resource] === 0) delete player.inventory[resource];
  mon.level += 1;
  mon.maxHp += 10;
  mon.hp = mon.maxHp;
  alert(`${mon.name} upgraded to Level ${mon.level}!`);
  beep(880, 140);
  savePlayer();
}

// ===== EVENT LISTENERS =====
function setupEventListeners() {
  document.getElementById('save-manual').addEventListener('click', savePlayer);
  document.getElementById('reset-game').addEventListener('click', resetPlayer);
  document.getElementById('open-pokedex').addEventListener('click', togglePokedex);
  document.getElementById('catch-pokemon').addEventListener('click', catchPokemon);
  document.getElementById('gather-resource').addEventListener('click', gatherResource);
  document.getElementById('bank-deposit-amount').addEventListener('change', e => depositMoney(e.target.value));
  document.getElementById('bank-withdraw-amount').addEventListener('change', e => withdrawMoney(e.target.value));
  document.getElementById('start-battle').addEventListener('click', () => startBattle(false));
  document.getElementById('challenge-gym').addEventListener('click', challengeGym);
  document.getElementById('start-gym-battle').addEventListener('click', startGymBattle);
  document.getElementById('sell-all-top').addEventListener('click', sellAll);
  const tradeMode = document.getElementById('trade-mode');
  if (tradeMode) tradeMode.addEventListener('change', updateUI);
}

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', () => {
  setupTabs();
  setupEventListeners();
  updateUI();

  // Register service worker for PWA
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js')
      .then(reg => console.log('Service Worker registered', reg))
      .catch(err => console.error('Service Worker registration failed', err));
  }
});
</script>
</body>
</html> 